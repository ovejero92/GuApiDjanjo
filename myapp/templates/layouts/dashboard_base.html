{% extends 'layouts/navbar.html' %}
{% load static %}
{% block title %}{% block dashboard_title %}Dashboard{% endblock %} - Turnos Online{% endblock %}

{% block content %}
<div class="dashboard-wrapper" data-onboarding-completo="{{ onboarding_completo|yesno:'True,False' }}">
    <div class="dashboard-layout">
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_turnos' %}active{% endif %}">
                        <a href="{% url 'dashboard_turnos' %}"><i class="fas fa-tasks"></i> <span>Gesti√≥n de Turnos</span></a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'dashboard_calendario' %}" class="nav-link">
                        <i class="fas fa-calendar-alt"></i> <span>Calendario</span>
                        </a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_horarios' %}active{% endif %}">
                        <a href="{% url 'dashboard_horarios' %}"><i class="fas fa-calendar-alt"></i> <span>Horarios y Bloqueos</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_catalogo' %}active{% endif %}">
                        <a href="{% url 'dashboard_catalogo' %}"><i class="fas fa-book-open"></i> <span>Cat√°logo de Servicios</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_detalles_negocio' %}active{% endif %}">
                    <a href="{% url 'dashboard_detalles_negocio' %}"><i class="fas fa-store"></i> <span>Detalles del Negocio</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_metricas' %}active{% endif %}">
                        <a href="{% url 'dashboard_metricas' %}" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard_metricas' %}active{% endif %}" title="{% if not user.suscripcion.plan.allow_metrics %}Funci√≥n Premium{% endif %}">
                            <i class="fas fa-chart-line"></i>
                            <span>M√©tricas y Reportes</span>
                            {% if not user.suscripcion.plan.allow_metrics %}
                                <span class="premium-badge">üëë</span>
                            {% endif %}
                        </a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_servicios' %}active{% endif %}">
                        <a href="{% url 'dashboard_servicios' %}" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard_servicios' %}active{% endif %}" title="{% if not user.suscripcion.plan.allow_customization %}Funci√≥n Premium{% endif %}">
                            <i class="fas fa-paint-brush"></i>
                            <span>Apariencia</span>
                            {% if not user.suscripcion.plan.allow_customization %}
                                <span class="premium-badge">üëë</span>
                            {% endif %}
                        </a>
                    </li>
                </ul>
            </nav>
            <button id="sidebarToggleBtn" class="sidebar-toggle-btn" title="Ocultar men√∫">
                <i class="fas fa-chevron-left"></i>
            </button>
        </aside>

         <main class="dashboard-content">
            {% if user.servicios_propios.count > 1 and servicio_activo %}
                <div class="servicio-selector">
                    <form method="get">
                        <label for="servicio_id">Gestionando Negocio:</label>
                        <select name="servicio_id" id="servicio_id" onchange="this.form.submit()">
                            {% for s in user.servicios_propios.all %}
                                <option value="{{ s.id }}" {% if s.id == servicio_activo.id %}selected{% endif %}>{{ s.nombre }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}
            {% block dashboard_content %}{% endblock %}
        </main>
    </div>
</div>
{% endblock %}


{% block scripts_extra %}
<style>
    .servicio-tag-container {
        display: flex;
        flex-wrap: wrap; 
        gap: 8px;
        align-items: center;
    }
    .servicio-tag {
        background-color: #033f63;
        color: #ffffff;
        padding: 5px 12px;
        border-radius: 16px;
        font-size: 0.9em;
        font-weight: 500;
        line-height: 1.2;
    }
    .container {
        padding: 0;
        max-width: 100%;
    }
    .dashboard-wrapper {
        height: calc(100vh - 80px);
        display: flex;
        overflow: hidden; 
    }
    .dashboard-layout {
        display: flex;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        gap: 20px;
        transition: gap 0.3s ease; 
    }
    .dashboard-sidebar {
        flex: 0 0 250px;
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        position: relative;
        transition: all 0.3s ease; 
        overflow: hidden; 
    }
    .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar-nav li a {
        display: flex; align-items: center; gap: 10px;
        padding: 12px 15px; color: #ccc; text-decoration: none;
        border-radius: 5px; transition: background-color 0.2s, color 0.2s;
        white-space: nowrap;
    }
    .sidebar-nav li a:hover { background-color: #444; color: #fff; }
    .sidebar-nav li.active a { background-color: #007bff; color: #fff; font-weight: bold; }
    .sidebar-nav i { width: 20px; text-align: center; }
    .dashboard-sidebar.collapsed {
        flex-basis: 70px;
        padding: 20px 0;
    }
    .dashboard-sidebar.collapsed .sidebar-nav li a {
        justify-content: center; 
    }
    .dashboard-sidebar.collapsed .sidebar-nav span {
        display: none; 
    }
    .dashboard-sidebar.collapsed .sidebar-toggle-btn i {
        transform: rotate(180deg);
    }
    .sidebar-toggle-btn {
        position: absolute;
        top: 50%;
        right: -13px; 
        transform: translateY(-50%);
        background-color: #007bff;
        color: white;
        border: 2px solid #202020;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .sidebar-toggle-btn:hover {
        background-color: aqua;
        color: #202020;
    }
    .sidebar-toggle-btn i {
        transition: transform 0.3s ease;
    }
    .dashboard-content {
        flex-grow: 1; 
        min-width: 0; 
        overflow-y: auto; 
        padding-right: 10px;
    }
    .dashboard-content::-webkit-scrollbar { width: 8px; }
    .dashboard-content::-webkit-scrollbar-track { background: transparent; }
    .dashboard-content::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    .dashboard-content::-webkit-scrollbar-thumb:hover { background: #777; }
    /* --- Estilos para las tablas y botones (los que ya ten√≠as) --- */
    .dashboard-section { background-color: #333; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    .turnos-table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #ccc; }
    .turnos-table th { padding: 12px 15px; text-align: left; font-weight: bold; color: #fff; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.05em; background-color: #444; }
    .turnos-table td { padding: 12px 15px; vertical-align: middle; }
    .turnos-table tbody tr { border-bottom: 1px solid #4a4a4a; }
    .turnos-table tbody tr:last-child { border-bottom: none; }
    .turnos-table td::before { display: none; }
    .servicio-selector { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
    .servicio-selector label { font-weight: bold; margin-right: 10px; }
    .servicio-selector select { background: #444; color: white; border: 1px solid #666; padding: 5px; border-radius: 4px; }
    .help-button { /* A√±ade esto si planeas usar los botones de ayuda contextual */
        background-color: #6c757d; color: white; border: none; border-radius: 50%;
        width: 30px; height: 30px; font-size: 1.1em; font-weight: bold;
        cursor: pointer; margin-left: 15px; vertical-align: middle;
    }
    .help-button-tour {
        background-color: #6c757d; color: white; border: none; border-radius: 50%;
        width: 30px; height: 30px; font-size: 1.1em; font-weight: bold;
        cursor: pointer;  vertical-align: middle;
    }
    .premium-blocker-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(40, 40, 40, 0.85); /* Fondo oscuro semitransparente */
    backdrop-filter: blur(5px); /* Efecto de desenfoque del fondo */
    z-index: 999; /* Se asegura de que est√© por encima de todo */
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    border-radius: 8px; /* Mismo borde que tus tarjetas */
}

.premium-blocker-content {
    text-align: center;
    color: #fff;
    max-width: 500px;
}

.premium-icon {
    font-size: 4em;
    display: block;
    margin-bottom: 20px;
}

.premium-blocker-content h2 {
    font-size: 2em;
    margin-bottom: 15px;
}

.premium-blocker-content p {
    font-size: 1.1em;
    color: #ccc;
    line-height: 1.6;
    margin-bottom: 30px;
}

.btn-upgrade {
    background-color: #28a745; /* Verde para la acci√≥n de mejorar */
    color: white;
    padding: 15px 30px;
    text-decoration: none;
    font-weight: bold;
    border-radius: 5px;
    transition: background-color 0.2s;
}

.btn-upgrade:hover {
    background-color: #218838;
}

/* Y un peque√±o ajuste para el contenedor principal */
.dashboard-section, .dashboard-grid {
    position: relative; /* Necesario para que el overlay se posicione correctamente */
}

.blocker-actions {
    display: flex;
    justify-content: center;
    gap: 15px; /* Espacio entre los botones */
    margin-top: 30px;
}

.btn-upgrade, .btn-back {
    padding: 12px 25px;
    text-decoration: none;
    font-weight: bold;
    border-radius: 5px;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
}

.btn-upgrade {
    background-color: #28a745; /* Verde para la acci√≥n principal */
    color: white;
}
.btn-upgrade:hover {
    background-color: #218838;
}

.btn-back {
    background-color: transparent;
    color: #ccc;
    border: 1px solid #555; /* Borde sutil para el bot√≥n secundario */
}
.btn-back:hover {
    background-color: #444;
    color: white;
}

    @media (max-width: 992px) {
        .dashboard-wrapper {
            height: auto; 
            overflow: visible; 
        }
        .dashboard-layout {
            flex-direction: column;
            padding: 10px;
        }
        .dashboard-sidebar {
            flex-shrink: 0; 
        }
        .dashboard-content {
            overflow-y: visible; 
            padding-right: 0;
        }
        .responsive-table thead { display: none; }
        .responsive-table tr { display: block; margin-bottom: 15px; border: 1px solid #555; border-radius: 5px; padding: 10px; background-color: #404040; }
        .responsive-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; padding: 10px 0; text-align: left; }
        .responsive-table tr td:last-child { border-bottom: 0; }
        .responsive-table td::before { display: inline-block; content: attr(data-label); font-weight: bold; color: #ccc; padding-right: 15px; }
        .responsive-table td .data-value { text-align: right; overflow-wrap: break-word; word-wrap: break-word; flex: 1; }
        .responsive-table td[data-label="Acciones"] { display: block; text-align: center; }
        .responsive-table td[data-label="Acciones"]::before { display: none; }
        .sidebar-toggle-btn {
            display: none;
        }
    }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('dashboardSidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');

    if (sidebar && toggleBtn) {
        const toggleIcon = toggleBtn.querySelector('i');

        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
                toggleBtn.title = "Mostrar men√∫";
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
                toggleBtn.title = "Ocultar men√∫";
            }
        });
    }

    const dashboardContainer = document.querySelector('.dashboard-wrapper');
    if (!dashboardContainer) return; 

    const onboardingCompleto = dashboardContainer.dataset.onboardingCompleto === 'True';

    if (onboardingCompleto) {
        return;
    }
    function marcarYFinalizarTour() {
            const csrfTokenInput = document.querySelector('form[action*="logout"] [name="csrfmiddlewaretoken"]');
            if (!csrfTokenInput) {
                console.error("No se pudo encontrar el token CSRF para marcar el onboarding.");
                return;
            }
            
            fetch("{% url 'marcar_onboarding_completo' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfTokenInput.value,
                    'Content-Type': 'application/json'
                },
            }).then(response => {
                if (response.ok) {
                    console.log('Onboarding marcado como completo. No volver√° a aparecer.');
                } else {
                    console.error("Fall√≥ la petici√≥n para marcar el onboarding.");
                }
            });
        }
        const posicionTooltip = window.innerWidth < 992 ? 'bottom' : 'right';
        const tour = new Shepherd.Tour({
            useModalOverlay: true,
            defaultStepOptions: {
                classes: 'shepherd-custom-theme',
                scrollTo: true,
                cancelIcon: { enabled: true },
            }
        });
        tour.addStep({
            title: '¬°Bienvenido a tu Dashboard!',
            text: 'Este es tu centro de control. Te daremos una gu√≠a general de las secciones.',
            buttons: [{ text: '¬°Vamos!', action: tour.next }]
        });
        tour.addStep({
            title:'<strong>‚ö†Ô∏èImportante‚ö†Ô∏è</strong>',
            text:'En cada secci√≥n vas a encontrar un boton al lado del t√≠tulo <button class="help-button-tour">?</button> para ver una guia del mismo',
            buttons:[{text:'Omitir tour',action:tour.cancel},{text:'Seguir Tour',action:tour.next}]
        });
        tour.addStep({
            title:'Gestion de Turnos',
            text:'Aqu√≠ podes <strong>cancelar o confirmar tus turnos</strong>. Al finalizar un turno es importante ingresar el importe obtenido para que impacte en tus m√©tricas.',
            attachTo:{element:'a[href*="{% url "dashboard_turnos" %}"]',on:posicionTooltip},
            buttons:[{text:'Siguiente',action:tour.next}]
        });
        tour.addStep({
            title:'Calendario',
            text:'Aqu√≠ podes <strong>Ver el calendario semanal</strong>. En esta seccion vas a poder todos los dias que tenes turnos agendados y visualizar cada dia.',
            attachTo:{element:'a[href*="{% url "dashboard_calendario" %}"]',on:posicionTooltip},
            buttons:[{text:'Siguiente',action:tour.next}]
        });
        tour.addStep({
            title: 'Horarios y Bloqueos',
            text: '<strong>¬°Este es el paso m√°s importante!</strong> Aqu√≠ debes definir tus d√≠as y horarios de trabajo para que los clientes puedan reservar sus turnos.',
            attachTo: { element: 'a[href*="horarios"]', on:posicionTooltip },
            buttons: [{ text: 'Siguiente', action: tour.next }]
        });
        tour.addStep({
            title: 'Cat√°logo de Servicios',
            text: 'Aqu√≠ podes <strong>crear y editar la lista de servicios</strong> que ofreces (Ej: "Corte de pelo"). Cada servicio requiere completar precio y duraci√≥n.',
            attachTo: { element: 'a[href*="catalogo"]', on:posicionTooltip },
            buttons: [{ text: 'Siguiente', action: tour.next }]
        });
        tour.addStep({
            title:'Detalles del negocio',
            text:'En esta secci√≥n pod√©s <strong>editar la informaci√≥n</strong>, podes modificar el nombre del servicio , la direcci√≥n , categoria.',
            attachTo:{element:'a[href*="{% url "dashboard_detalles_negocio" %}"]',on:posicionTooltip},
            buttons:[{ text: 'Siguiente', action: tour.next }]
        });
        tour.addStep({
            title:'M√©tricas y Reportes',
            text:'En esta secci√≥n pod√©s ver <strong>los n√∫meros m√°s importantes de tu negocio</strong>, como las ventas, servicios m√°s vendidos y resultados generales.',
            attachTo:{element:'a[href$="dashboard/metricas/"]',on:posicionTooltip},
            buttons:[{text:'Siguiente',action:tour.next}]
        });
        tour.addStep({
            title:'Apariencia',
            text:'En esta secci√≥n pod√©s <strong>personalizar la apariencia de tu tienda</strong>, como los colores, logo y dise√±o.',
            attachTo:{element:'a[href*="{% url "dashboard_servicios" %}"]',on:posicionTooltip},
            buttons:[{ text: 'Siguiente', action: tour.next }]
        });
        tour.addStep({
            title: '¬°Todo listo!',
            text: 'Ya conoces lo esencial. Explora las dem√°s secciones cuando quieras. ¬°Muchos √©xitos!',
            buttons: [{ text: 'Finalizar Tour', action:function() {
                        // Al hacer clic, PRIMERO marcamos como completo y LUEGO redirigimos.
                        marcarYFinalizarTour();
                        window.location.href = "{% url 'dashboard_horarios' %}";
                    } }]
        });
        tour.on('cancel', marcarYFinalizarTour);
        tour.start();
    }
    );
</script>
{% endblock %}