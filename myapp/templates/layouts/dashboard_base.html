{% extends 'layouts/navbar.html' %}
{% load static %}

{% block content %}
<div class="dashboard-wrapper" data-onboarding-completo="{{ onboarding_completo|yesno:'True,False' }}">
    <div class="dashboard-layout">
        <!-- MENÚ LATERAL (SIDEBAR) -->
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_turnos' %}active{% endif %}">
                        <a href="{% url 'dashboard_turnos' %}"><i class="fas fa-tasks"></i> <span>Gestión de Turnos</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_horarios' %}active{% endif %}">
                        <a href="{% url 'dashboard_horarios' %}"><i class="fas fa-calendar-alt"></i> <span>Horarios y Bloqueos</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_metricas' %}active{% endif %}">
                        <a href="{% url 'dashboard_metricas' %}"><i class="fas fa-chart-line"></i> <span>Métricas y Reportes</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_catalogo' %}active{% endif %}">
                        <a href="{% url 'dashboard_catalogo' %}"><i class="fas fa-book-open"></i> <span>Catálogo de Servicios</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_servicios' %}active{% endif %}">
                        <a href="{% url 'dashboard_servicios' %}"><i class="fas fa-cut"></i> <span>Apariencia</span></a>
                    </li>
                    <li class="{% if request.resolver_match.url_name == 'dashboard_detalles_negocio' %}active{% endif %}">
                    <a href="{% url 'dashboard_detalles_negocio' %}"><i class="fas fa-store"></i> <span>Detalles del Negocio</span></a>
                    </li>
                </ul>
            </nav>
            <button id="sidebarToggleBtn" class="sidebar-toggle-btn" title="Ocultar menú">
                <i class="fas fa-chevron-left"></i>
            </button>
        </aside>

        <!-- ÁREA DE CONTENIDO PRINCIPAL -->
         <main class="dashboard-content">
            {% if user.servicios_propios.count > 1 and servicio_activo %}
                <div class="servicio-selector">
                    <form method="get">
                        <label for="servicio_id">Gestionando Negocio:</label>
                        <select name="servicio_id" id="servicio_id" onchange="this.form.submit()">
                            {% for s in user.servicios_propios.all %}
                                <option value="{{ s.id }}" {% if s.id == servicio_activo.id %}selected{% endif %}>{{ s.nombre }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}
            {% block dashboard_content %}{% endblock %}
        </main>
    </div>
</div>
{% endblock %}


{% block scripts_extra %}
<style>
    /* --- Contenedor Principal y Layout --- */
    /* Quitamos el padding del .container de la navbar para usar todo el ancho */
        .servicio-tag-container {
        display: flex;
        flex-wrap: wrap; /* Permite que las etiquetas pasen a la siguiente línea si no caben */
        gap: 8px;      /* Espacio entre cada etiqueta */
        align-items: center;
    }
    
    .servicio-tag {
        background-color: #033f63; /* El fondo azul que pediste */
        color: #ffffff;           /* Letra blanca para un buen contraste */
        padding: 5px 12px;         /* Espaciado interno para que no se vea apretado */
        border-radius: 16px;       /* Bordes completamente redondeados para un look de "píldora" */
        font-size: 0.9em;          /* Un tamaño de letra ligeramente más pequeño */
        font-weight: 500;
        line-height: 1.2;
    }
    .container {
        padding: 0;
        max-width: 100%;
    }
    .dashboard-wrapper {
        height: calc(100vh - 80px); /* Altura total de la ventana menos la navbar */
        display: flex;
        overflow: hidden; /* Evita cualquier scroll en el contenedor principal */
    }
    .dashboard-layout {
        display: flex;
        width: 100%;
        max-width: 1600px; /* Ancho máximo para el contenido */
        margin: 0 auto;
        padding: 20px;
        gap: 20px;
        transition: gap 0.3s ease; /* Transición suave para el gap */
    }

    /* --- Sidebar (Menú Lateral) --- */
    .dashboard-sidebar {
        flex: 0 0 250px; /* Base fija de 250px */
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        position: relative; /* Necesario para posicionar el botón de toggle */
        transition: all 0.3s ease; /* Transición suave para colapsar/expandir */
        overflow: hidden; /* Oculta el texto cuando se colapsa */
    }
    .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
    .sidebar-nav li a {
        display: flex; align-items: center; gap: 10px;
        padding: 12px 15px; color: #ccc; text-decoration: none;
        border-radius: 5px; transition: background-color 0.2s, color 0.2s;
        white-space: nowrap; /* Evita que el texto se rompa */
    }
    .sidebar-nav li a:hover { background-color: #444; color: #fff; }
    .sidebar-nav li.active a { background-color: #007bff; color: #fff; font-weight: bold; }
    .sidebar-nav i { width: 20px; text-align: center; }

    .dashboard-sidebar.collapsed {
        flex-basis: 70px; /* Ancho cuando está colapsado */
        padding: 20px 0;
    }
    .dashboard-sidebar.collapsed .sidebar-nav li a {
        justify-content: center; /* Centra el ícono */
    }
    .dashboard-sidebar.collapsed .sidebar-nav span {
        display: none; /* Oculta el texto del enlace */
    }
    .dashboard-sidebar.collapsed .sidebar-toggle-btn i {
        transform: rotate(180deg); /* Gira la flecha */
    }

    /* --- Botón para Ocultar/Mostrar --- */
    .sidebar-toggle-btn {
        position: absolute;
        top: 50%;
        right: -13px; /* Lo saca un poco del borde */
        transform: translateY(-50%);
        background-color: #007bff;
        color: white;
        border: 2px solid #202020;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .sidebar-toggle-btn:hover {
        background-color: aqua;
        color: #202020;
    }
    .sidebar-toggle-btn i {
        transition: transform 0.3s ease;
    }

    /* --- Contenido Principal (con scroll propio) --- */
    .dashboard-content {
        flex-grow: 1; /* Ocupa el espacio restante */
        min-width: 0; /* Solución clave para evitar desbordamiento en flexbox */
        overflow-y: auto; /* AÑADE SCROLL VERTICAL SÓLO A ESTA COLUMNA */
        padding-right: 10px; /* Espacio para que el scroll no tape el contenido */
    }
    /* Estilo del scrollbar */
    .dashboard-content::-webkit-scrollbar { width: 8px; }
    .dashboard-content::-webkit-scrollbar-track { background: transparent; }
    .dashboard-content::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    .dashboard-content::-webkit-scrollbar-thumb:hover { background: #777; }

    /* --- Estilos para las tablas y botones (los que ya tenías) --- */
    .dashboard-section { background-color: #333; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    .turnos-table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #ccc; }
    .turnos-table th { padding: 12px 15px; text-align: left; font-weight: bold; color: #fff; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.05em; background-color: #444; }
    .turnos-table td { padding: 12px 15px; vertical-align: middle; }
    .turnos-table tbody tr { border-bottom: 1px solid #4a4a4a; }
    .turnos-table tbody tr:last-child { border-bottom: none; }
    .turnos-table td::before { display: none; }
    .servicio-selector { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
    .servicio-selector label { font-weight: bold; margin-right: 10px; }
    .servicio-selector select { background: #444; color: white; border: 1px solid #666; padding: 5px; border-radius: 4px; }
    .help-button { /* Añade esto si planeas usar los botones de ayuda contextual */
        background-color: #6c757d; color: white; border: none; border-radius: 50%;
        width: 30px; height: 30px; font-size: 1.1em; font-weight: bold;
        cursor: pointer; margin-left: 15px; vertical-align: middle;
    }
    .help-button-tour {
        background-color: #6c757d; color: white; border: none; border-radius: 50%;
        width: 30px; height: 30px; font-size: 1.1em; font-weight: bold;
        cursor: pointer;  vertical-align: middle;
    }
    /* ================================================================ */
    /* ==========            ESTILOS RESPONSIVOS             ========== */
    /* ================================================================ */
    @media (max-width: 992px) {
        .dashboard-wrapper {
            height: auto; /* En móvil, la altura es automática */
            overflow: visible; /* Devolvemos el scroll al body */
        }
        .dashboard-layout {
            flex-direction: column;
            padding: 10px;
        }
        .dashboard-sidebar {
            flex-shrink: 0; /* Evita que se encoja */
        }
        .dashboard-content {
            overflow-y: visible; /* Ya no necesita su propio scroll */
            padding-right: 0;
        }

        /* Transformación de la tabla a tarjetas (la que ya tenías) */
        .responsive-table thead { display: none; }
        .responsive-table tr { display: block; margin-bottom: 15px; border: 1px solid #555; border-radius: 5px; padding: 10px; background-color: #404040; }
        .responsive-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; padding: 10px 0; text-align: left; }
        .responsive-table tr td:last-child { border-bottom: 0; }
        .responsive-table td::before { display: inline-block; content: attr(data-label); font-weight: bold; color: #ccc; padding-right: 15px; }
        .responsive-table td .data-value { text-align: right; overflow-wrap: break-word; word-wrap: break-word; flex: 1; }
        .responsive-table td[data-label="Acciones"] { display: block; text-align: center; }
        .responsive-table td[data-label="Acciones"]::before { display: none; }
        .sidebar-toggle-btn {
            display: none;
        }
    }
</style>
<!-- Librerías para el Tour Interactivo (Shepherd.js) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('dashboardSidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');

    // GUARDIÁN: Solo ejecutar si los elementos del dashboard existen en esta página.
    if (sidebar && toggleBtn) {
        const toggleIcon = toggleBtn.querySelector('i');

        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
                toggleBtn.title = "Mostrar menú";
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
                toggleBtn.title = "Ocultar menú";
            }
        });
    }

     // --- LÓGICA DEL TOUR DE BIENVENIDA (CORREGIDA) ---
    const dashboardContainer = document.querySelector('.dashboard-wrapper');
    if (!dashboardContainer) return; // Salir si no estamos en una página de dashboard

    const onboardingCompleto = dashboardContainer.dataset.onboardingCompleto === 'True';

    // Si el tour ya se vio, no hacer nada.
    if (onboardingCompleto) {
        return;
    }
    // Solo si el onboarding NO está completo, definimos y ejecutamos todo lo del tour

        // 1. Definimos la función de marcado PRIMERO
        function marcarYFinalizarTour() {
            const csrfTokenInput = document.querySelector('form[action*="logout"] [name="csrfmiddlewaretoken"]');
            if (!csrfTokenInput) {
                console.error("No se pudo encontrar el token CSRF para marcar el onboarding.");
                return;
            }
            
            fetch("{% url 'marcar_onboarding_completo' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfTokenInput.value,
                    'Content-Type': 'application/json'
                },
            }).then(response => {
                if (response.ok) {
                    console.log('Onboarding marcado como completo. No volverá a aparecer.');
                    // Opcional: recargar la página para que el data-attribute cambie al instante
                    // window.location.reload(); 
                } else {
                    console.error("Falló la petición para marcar el onboarding.");
                }
            });
        }

        const posicionTooltip = window.innerWidth < 992 ? 'bottom' : 'right';

        // 2. Creamos la instancia del tour
        const tour = new Shepherd.Tour({
            useModalOverlay: true,
            defaultStepOptions: {
                classes: 'shepherd-custom-theme',
                scrollTo: true,
                cancelIcon: { enabled: true },
            }
        });

        // 3. Añadimos los pasos del tour
        tour.addStep({
            title: '¡Bienvenido a tu Dashboard!',
            text: 'Este es tu centro de control. Te daremos una guía general de las secciones.',
            buttons: [{ text: '¡Vamos!', action: tour.next }]
        });

        tour.addStep({
            title:'<strong>⚠️Importante⚠️</strong>',
            text:'En cada sección vas a encontrar un boton al lado del título <button class="help-button-tour">?</button> para ver una guia del mismo',
            buttons:[{text:'Omitir tour',action:tour.cancel},{text:'Seguir Tour',action:tour.next}]
        });

        tour.addStep({
            title:'Gestion de Turnos',
            text:'Aquí podes <strong>cancelar o confirmar tus turnos</strong>. Al finalizar un turno es importante ingresar el importe obtenido para que impacte en tus métricas.',
            attachTo:{element:'a[href*="{% url "dashboard_turnos" %}"]',on:posicionTooltip},
            buttons:[{text:'Siguiente',action:tour.next}]
        });

        tour.addStep({
            title: 'Horarios y Bloqueos',
            text: '<strong>¡Este es el paso más importante!</strong> Aquí debes definir tus días y horarios de trabajo para que los clientes puedan reservar sus turnos.',
            attachTo: { element: 'a[href*="horarios"]', on:posicionTooltip },
            buttons: [{ text: 'Siguiente', action: tour.next }]
        });

        tour.addStep({
            title:'Métricas y Reportes',
            text:'En esta sección podés ver <strong>los números más importantes de tu negocio</strong>, como las ventas, servicios más vendidos y resultados generales.',
            attachTo:{element:'a[href$="dashboard/metricas/"]',on:posicionTooltip},
            buttons:[{text:'Siguiente',action:tour.next}]
        });

        tour.addStep({
            title: 'Catálogo de Servicios',
            text: 'Aquí podes <strong>crear y editar la lista de servicios</strong> que ofreces (Ej: "Corte de pelo"). Cada servicio requiere completar precio y duración.',
            attachTo: { element: 'a[href*="catalogo"]', on:posicionTooltip },
            buttons: [{ text: 'Siguiente', action: tour.next }]
        });

        tour.addStep({
            title:'Apariencia',
            text:'En esta sección podés <strong>personalizar la apariencia de tu tienda</strong>, como los colores, logo y diseño.',
            attachTo:{element:'a[href*="{% url "dashboard_servicios" %}"]',on:posicionTooltip},
            buttons:[{ text: 'Siguiente', action: tour.next }]
        });
        
        tour.addStep({
            title: '¡Todo listo!',
            text: 'Ya conoces lo esencial. Explora las demás secciones cuando quieras. ¡Muchos éxitos!',
            buttons: [{ text: 'Finalizar Tour', action:function() {
                        // Al hacer clic, PRIMERO marcamos como completo y LUEGO redirigimos.
                        marcarYFinalizarTour();
                        window.location.href = "{% url 'dashboard_horarios' %}";
                    } }]
        });

        tour.on('cancel', marcarYFinalizarTour);

        // 5. Iniciamos el tour
        tour.start();
    }

    );
</script>
{% endblock %}