{% extends 'layouts/dashboard_base.html' %}
{% block dashboard_title %}Manejo de horarios{% endblock %}

{% block dashboard_content %}
    <div style="display: flex; align-items: center; gap: 15px;">
        <h1>Horarios y Disponibilidad</h1>
        <button id="ayudaHorariosBtn" class="help-button" title="Ver guía de esta sección">?</button>
    </div>
    <p>Define tus reglas de trabajo. Puedes crear una regla simple para "Lunes a Viernes" y otra solo para "Sábados".</p>
    
    {% if no_hay_servicio %}
        <div class="dashboard-section"><p>Aún no tienes un servicio configurado.</p></div>
    {% else %}
        <div class="dashboard-section" id="seccion-horario-semanal">
            <h2>Reglas de Horario Semanal</h2>
            
            <form method="post" id="form-horarios">
                {% csrf_token %}
                {{ formset.management_form }}

                <div id="reglas-container">
                    {% for form in formset %}
                        <div class="regla-horario-card">
                            {{ form.id }}
                            {% if form.non_field_errors %}<div class="form-error-box">{{ form.non_field_errors }}</div>{% endif %}

                            <div class="form-group">
                                <label>Días de la semana para esta regla:</label>
                                <div class="dias-botones-container">
                                    {# Renderizamos cada checkbox a mano para tener control total #}
                                    {% for checkbox in form.dias_semana %}
                                        {{ checkbox.tag }}
                                        <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="horas-grid">
                                <div class="form-group">
                                    {{ form.horario_apertura.label_tag }} {{ form.horario_apertura }}
                                </div>
                                <div class="form-group">
                                    {{ form.horario_cierre.label_tag }} {{ form.horario_cierre }}
                                </div>
                            </div>

                            <div class="descanso-toggle">
                                {{ form.tiene_descanso }} {{ form.tiene_descanso.label_tag }}
                            </div>
                            <div class="horas-grid descanso-horas">
                                <div class="form-group">
                                    {{ form.descanso_inicio.label_tag }} {{ form.descanso_inicio }}
                                </div>
                                <div class="form-group">
                                    {{ form.descanso_fin.label_tag }} {{ form.descanso_fin }}
                                </div>
                            </div>

                            <div class="regla-acciones">
                                <div class="form-group-inline">
                                    {{ form.activo }} {{ form.activo.label_tag }}
                                </div>
                                {% if form.instance.pk and formset.can_delete %}
                                    <div class="form-group-inline delete-group">
                                        <label for="{{ form.DELETE.id_for_label }}" class="delete-label">
                                            {{ form.DELETE }} Eliminar
                                        </label>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Template para clonar -->
                <template id="regla-horario-template">
                    <div class="regla-horario-card">
                        {{ formset.empty_form.id }}
                        <div class="form-group">
                            <label>Días de la semana para esta regla:</label>
                            <div class="dias-botones-container">
                                {% for checkbox in formset.empty_form.dias_semana %}
                                    {{ checkbox.tag }}
                                    <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="horas-grid">
                            <div class="form-group">
                                {{ formset.empty_form.horario_apertura.label_tag }} {{ formset.empty_form.horario_apertura }}
                            </div>
                            <div class="form-group">
                                {{ formset.empty_form.horario_cierre.label_tag }} {{ formset.empty_form.horario_cierre }}
                            </div>
                        </div>
                        <div class="descanso-toggle">
                            {{ formset.empty_form.tiene_descanso }} {{ formset.empty_form.tiene_descanso.label_tag }}
                        </div>
                        <div class="horas-grid descanso-horas">
                            <div class="form-group">
                                {{ formset.empty_form.descanso_inicio.label_tag }} {{ formset.empty_form.descanso_inicio }}
                            </div>
                            <div class="form-group">
                                {{ formset.empty_form.descanso_fin.label_tag }} {{ formset.empty_form.descanso_fin }}
                            </div>
                        </div>
                        <div class="regla-acciones">
                            <div class="form-group-inline">
                                {{ formset.empty_form.activo }} {{ formset.empty_form.activo.label_tag }}
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="form-actions">
                    <button type="button" id="add-rule-btn" class="btn-secondary"><i class="fas fa-plus"></i> Añadir Regla</button>
                    <button type="submit" name="guardar_horarios" class="btn-submit">Guardar Horarios</button>
                </div>
            </form>
        </div>

        <div class="dashboard-section" id="seccion-bloqueo-fechas">
            <h2>Bloquear Fechas o Periodos</h2>
            <form method="post" class="bloqueo-form">
                {% csrf_token %}
                {{ bloqueo_form.as_p }}
                <button type="submit" name="crear_bloqueo" class="btn-submit">Crear Bloqueo</button>
            </form>
            <hr style="margin: 30px 0; border-color: #555;">
            <h3>Próximos Bloqueos</h3>
            {% if bloqueos %}
                <ul class="lista-bloqueos">
                    {% for bloqueo in bloqueos %}
                        <li>
                            <span>
                                <strong>{{ bloqueo.fecha|date:"d/m/Y" }}:</strong> 
                                {% if bloqueo.hora_inicio %}
                                    de {{ bloqueo.hora_inicio|time:"H:i" }} a {{ bloqueo.hora_fin|time:"H:i" }}
                                {% else %}
                                    Día completo
                                {% endif %}
                                ({{ bloqueo.motivo|default:"Sin motivo" }})
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No tienes bloqueos programados.</p>
            {% endif %}
        </div>
    {% endif %}

    <style>
        .horarios-form-container {
        background-color: #2c2c2c;
        padding: 25px;
        border-radius: 8px;
    }
    .horarios-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .horarios-table th, .horarios-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #444;
    }
    .horarios-table th {
        color: #ccc;
        font-size: 0.9em;
        text-transform: uppercase;
    }
    .horarios-table td {
        vertical-align: middle;
    }
    /* ¡LA SOLUCIÓN! Le damos estilo a nuestros inputs */
    .form-control {
        width: 100%;
        padding: 8px;
        background-color: #3a3a3a;
        border: 1px solid #555;
        color: #fff;
        border-radius: 4px;
        min-width: 100px; /* Ancho mínimo para que no se colapse */
    }
    .form-check-input {
        width: 20px;
        height: 20px;
    }
    .regla-horario-form {
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .regla-horario-form fieldset {
            border: none; padding: 0; margin: 0 0 15px 0;
        }
        .regla-horario-form legend {
            font-weight: bold; color: #ccc; margin-bottom: 10px; font-size: 1.1em;
        }
        .dias-checkboxes {
            display: flex; flex-wrap: wrap; gap: 10px 20px;
        }
        .dias-checkboxes label {
            display: flex; align-items: center; gap: 8px; font-weight: normal;
        }
        .horas-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px;
        }
        .descanso-fieldset .descanso-horas {
            display: none; /* Oculto por defecto */
            margin-top: 15px;
        }
        .regla-acciones {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;
        }
        .form-group-inline {
            display: flex; align-items: center; gap: 8px;
        }
        .delete-group label {
            color: #ff6b6b;
        }
        .form-actions {
            margin-top: 20px; display: flex; gap: 15px;
        }
        .btn-secondary {
            background: transparent; border: 1px solid #666; color: #ccc; padding: 10px 15px;
            border-radius: 5px; cursor: pointer; transition: background-color 0.2s;
        }
         .regla-horario-card {
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }

        /* LA MAGIA PARA LOS BOTONES DE DÍAS */
        .dias-botones-container {
            display: flex; flex-wrap: wrap; gap: 10px;
        }
        /* Ocultamos el checkbox real */
        .dias-botones-container input[type="checkbox"] {
            display: none;
        }
        /* Le damos estilo al label para que parezca un botón */
        .dias-botones-container label {
            padding: 8px 12px;
            background-color: #555;
            color: #ccc;
            border: 1px solid #777;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: normal;
            font-size: 0.9em;
        }
        /* Cuando el checkbox oculto está seleccionado, cambiamos el estilo del label */
        .dias-botones-container input[type="checkbox"]:checked + label {
            background-color: var(--color-primario, #007bff);
            color: white;
            border-color: var(--color-primario, #007bff);
            font-weight: bold;
        }
 .dias-botones-container label {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        /* Hacemos los labels de los inputs más pequeños */
        .regla-horario-card .form-group label {
            font-size: 0.9em;
            color: #bbb;
        }

        /* Estilo para el toggle de descanso */
        .descanso-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #2f2f2f;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }

        /* Hacemos el botón de eliminar mucho más claro */
        .delete-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ff8a8a; /* Un rojo suave */
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .delete-label:hover {
            background-color: rgba(255, 100, 100, 0.1);
        }
        .form-error-box {
            background-color: #5d1a1a;
            color: #ffbaba;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .horas-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        .descanso-toggle { margin-top: 15px; }
        .descanso-horas {
            display: none; /* Oculto por defecto */
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }
        .regla-acciones {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid #444; padding-top: 15px; margin-top: 20px;
        }
        .form-group-inline {
            display: flex; align-items: center; gap: 8px;
        }
        .delete-group label { color: #ff6b6b; }
        .form-actions {
            margin-top: 20px; display: flex; gap: 15px;
        }
        .btn-secondary:hover { background-color: #444; }
        .form-error { color: #ff6b6b; font-size: 0.9em; margin-top: 5px; }
        .schedule-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .schedule-table th, .schedule-table td { padding: 12px; border: 1px solid #444; text-align: center; }
        .schedule-table th { background-color: #3a3a3a; }
        .schedule-table input, .schedule-table select { background-color: #555; color: white; border: 1px solid #777; padding: 5px; border-radius: 4px; }
        .btn-submit { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .bloqueo-form p { margin-bottom: 15px; }
        .lista-bloqueos { list-style: none; padding-left: 0; }
        .lista-bloqueos li { background-color: #444; padding: 10px; border-radius: 4px; margin-bottom: 8px; }
        .inp input{width: 30px;}
        @media (max-width: 768px) {
            .schedule-table thead { display: none; }
            .schedule-table, .schedule-table tbody, .schedule-table tr, .schedule-table td { display: block; }
            .schedule-table tr { border: 1px solid #555; border-radius: 8px; margin-bottom: 15px; padding: 10px; }
            .schedule-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 10px 5px; border: none; border-bottom: 1px solid #4a4a4a; }
            .schedule-table tr td:last-child { border-bottom: none; }
            .schedule-table td::before { content: attr(data-label); font-weight: bold; color: #ccc; text-align: left; }
        }
    </style>
{% endblock %}

{% block scripts_extra %}
    {{ block.super }} {# ¡CRUCIAL! Esto incluye el script del tour de bienvenida de la plantilla base #}

 <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- LÓGICA PARA MANEJAR EL DESCANSO Y AÑADIR NUEVAS REGLAS ---
        function setupFormCard(cardElement) {
            const descansoCheckbox = cardElement.querySelector('input[name$="-tiene_descanso"]');
            const horasDiv = cardElement.querySelector('.descanso-horas');
            
            if (descansoCheckbox && horasDiv) {
                function toggleDescanso() {
                    horasDiv.style.display = descansoCheckbox.checked ? 'grid' : 'none';
                }
                toggleDescanso();
                descansoCheckbox.addEventListener('change', toggleDescanso);
            }
        }
        
        // Aplica la lógica a todos los formularios que ya existen
        document.querySelectorAll('.regla-horario-card').forEach(setupFormCard);

        const addRuleBtn = document.getElementById('add-rule-btn');
        const container = document.getElementById('reglas-container');
        const templateNode = document.getElementById('regla-horario-template');
        const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

        if (addRuleBtn && container && templateNode && totalFormsInput) {
            addRuleBtn.addEventListener('click', function() {
                let formIdx = parseInt(totalFormsInput.value);
                
                // Clonamos el contenido del template
                let newFormHtml = templateNode.innerHTML.replace(/__prefix__/g, formIdx);
                
                // Creamos un nuevo div y le metemos el HTML clonado
                let newDiv = document.createElement('div');
                newDiv.innerHTML = newFormHtml;
                const newCard = newDiv.firstElementChild; // Obtenemos el .regla-horario-card
                
                // Añadimos el nuevo formulario al contenedor
                container.appendChild(newCard);

                totalFormsInput.value = formIdx + 1;

                // Aplicamos la lógica al nuevo formulario
                setupFormCard(newCard);
            });
        }

         const botonAyuda = document.getElementById('ayudaHorariosBtn');
    if (botonAyuda) {

        botonAyuda.addEventListener('click', function() {
            if (Shepherd.activeTour) Shepherd.activeTour.cancel();

            const tourGeneral = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shepherd-custom-theme',
                    scrollTo: true,
                    cancelIcon: { enabled: true },
                }
            });

            function startSubTourHorario(callback) {
                const subTour = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shepherd-custom-theme',
                        scrollTo: true,
                        cancelIcon: { enabled: true },
                    }
                });

                subTour.addStep({
                    title: 'Checkbox Abierto',
                    text: 'Activa o desactiva este checkbox para definir si ese día está habilitado.',
                    attachTo: { element: 'td[data-label="Abierto"] input', on: 'right' },
                    buttons: [{ text: 'Siguiente', action: subTour.next }]
                });

                subTour.addStep({
                    title: 'Horarios',
                    text: 'Define el horario de apertura y cierre.',
                    attachTo: { element: 'td[data-label="Apertura"] input', on: 'left' },
                    buttons: [{ text: 'Siguiente', action: subTour.next }]
                });

                subTour.addStep({
                    title: 'Eliminar Día',
                    text: 'Marca este checkbox y guarda para eliminar ese día.',
                    attachTo: { element: 'td[data-label="Eliminar"] input', on: 'left' },
                    buttons: [{ text: 'Finalizar', action: () => { subTour.complete(); callback(); } }]
                });

                subTour.start();
            }

            function startSubTourBloqueo(callback) {
                const subTour = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shepherd-custom-theme',
                        scrollTo: true,
                        cancelIcon: { enabled: true },
                    }
                });

                subTour.addStep({
                    title: 'Formulario de Bloqueo',
                    text: 'Completa este formulario para bloquear un día o un rango de horas.',
                    attachTo: { element: '.bloqueo-form', on: 'top' },
                    buttons: [{ text: 'Finalizar', action: () => { subTour.complete(); callback(); } }]
                });

                subTour.start();
            }

            tourGeneral.addStep({
                title: 'Configuración Semanal',
                text: 'Aquí defines los días que trabajás y tus horarios.',
                attachTo: { element: '#seccion-horario-semanal', on: 'bottom' },
                buttons: [
                    {
                        text: 'Ejemplo',
                        action: function () {
                            tourGeneral.cancel(); 
                            startSubTourHorario(() => tourGeneral.start());  
                        }
                    },
                    { text: 'Siguiente', action: tourGeneral.next }
                ]
            });

            tourGeneral.addStep({
                title: 'Bloquear Fechas',
                text: 'Aquí podés bloquear fechas o periodos especiales.',
                attachTo: { element: '#seccion-bloqueo-fechas', on: 'top' },
                buttons: [
                    {
                        text: 'Ejemplo',
                        action: function () {
                            tourGeneral.cancel();
                            startSubTourBloqueo(() => tourGeneral.start());
                        }
                    },
                    { text: 'Finalizar', action: tourGeneral.complete }
                ]
            });

            tourGeneral.start();
        });
    }

    });
    </script>
{% endblock %}