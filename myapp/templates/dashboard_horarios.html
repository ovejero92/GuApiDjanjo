{% extends 'layouts/dashboard_base.html' %}
{% block dashboard_title %}Manejo de horarios{% endblock %}

{% block dashboard_content %}
    <div style="display: flex; align-items: center; gap: 15px;">
        <h1>Horarios y Disponibilidad</h1>
        <button id="ayudaHorariosBtn" class="help-button" title="Ver guía de esta sección">?</button>
    </div>
    <p>Define tus reglas de trabajo. Puedes crear una regla simple para "Lunes a Viernes" y otra solo para "Sábados".</p>
    
    {% if no_hay_servicio %}
        <div class="dashboard-section"><p>Aún no tienes un servicio configurado.</p></div>
    {% else %}
        <div class="dashboard-section" id="seccion-horario-semanal">
            <h2>Reglas de Horario Semanal</h2>
            
            <form method="post" id="form-horarios">
                {% csrf_token %}
                {{ formset.management_form }}

                <div id="reglas-container">
                    {% for form in formset %}
                        <div class="regla-horario-card">
                            {{ form.id }}
                            {% if form.non_field_errors %}<div class="form-error-box">{{ form.non_field_errors }}</div>{% endif %}

                            <div class="form-group">
                                <label>Días de la semana para esta regla:</label>
                                <div class="dias-botones-container">
                                    {# Renderizamos cada checkbox a mano para tener control total #}
                                    {% for checkbox in form.dias_semana %}
                                        {{ checkbox.tag }}
                                        <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="horas-grid">
                                <div class="form-group">
                                    {{ form.horario_apertura.label_tag }} {{ form.horario_apertura }}
                                </div>
                                <div class="form-group">
                                    {{ form.horario_cierre.label_tag }} {{ form.horario_cierre }}
                                </div>
                            </div>

                            <div class="descanso-toggle">
                                {{ form.tiene_descanso }} {{ form.tiene_descanso.label_tag }}
                            </div>
                            <div class="horas-grid descanso-horas">
                                <div class="form-group">
                                    {{ form.descanso_inicio.label_tag }} {{ form.descanso_inicio }}
                                </div>
                                <div class="form-group">
                                    {{ form.descanso_fin.label_tag }} {{ form.descanso_fin }}
                                </div>
                            </div>

                            <div class="regla-acciones">
                                <div class="form-group-inline">
                                    {{ form.activo }} {{ form.activo.label_tag }}
                                </div>
                                {% if form.instance.pk and formset.can_delete %}
                                    <div class="form-group-inline delete-group">
                                        <label for="{{ form.DELETE.id_for_label }}" class="delete-label">
                                            {{ form.DELETE }} Eliminar
                                        </label>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Template para clonar -->
                <template id="regla-horario-template">
                    <div class="regla-horario-card">
                        {{ formset.empty_form.id }}
                        <div class="form-group">
                            <label>Días de la semana para esta regla:</label>
                            <div class="dias-botones-container">
                                {% for checkbox in formset.empty_form.dias_semana %}
                                    {{ checkbox.tag }}
                                    <label for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="horas-grid">
                            <div class="form-group">
                                {{ formset.empty_form.horario_apertura.label_tag }} {{ formset.empty_form.horario_apertura }}
                            </div>
                            <div class="form-group">
                                {{ formset.empty_form.horario_cierre.label_tag }} {{ formset.empty_form.horario_cierre }}
                            </div>
                        </div>
                        <div class="descanso-toggle">
                            {{ formset.empty_form.tiene_descanso }} {{ formset.empty_form.tiene_descanso.label_tag }}
                        </div>
                        <div class="horas-grid descanso-horas">
                            <div class="form-group">
                                {{ formset.empty_form.descanso_inicio.label_tag }} {{ formset.empty_form.descanso_inicio }}
                            </div>
                            <div class="form-group">
                                {{ formset.empty_form.descanso_fin.label_tag }} {{ formset.empty_form.descanso_fin }}
                            </div>
                        </div>
                        <div class="regla-acciones">
                            <div class="form-group-inline">
                                {{ formset.empty_form.activo }} {{ formset.empty_form.activo.label_tag }}
                            </div>
                        </div>
                    </div>
                </template>
                
                <div class="form-actions">
                    <button type="button" id="add-rule-btn" class="btn-secondary"><i class="fas fa-plus"></i> Añadir Regla</button>
                    <button type="submit" name="guardar_horarios" class="btn-submit">Guardar Horarios</button>
                </div>
            </form>
        </div>

        <div class="dashboard-section" id="seccion-bloqueo-fechas">
            <h2>Bloquear Fechas o Periodos</h2>
            <form method="post" class="bloqueo-form">
                {% csrf_token %}
                {{ bloqueo_form.as_p }}
                <button type="submit" name="crear_bloqueo" class="btn-submit">Crear Bloqueo</button>
            </form>
            <hr style="margin: 30px 0; border-color: #555;">
            <h3>Próximos Bloqueos</h3>
            {% if bloqueos %}
                <ul class="lista-bloqueos">
                    {% for bloqueo in bloqueos %}
                        <li>
                            <span>
                                <strong>{{ bloqueo.fecha|date:"d/m/Y" }}:</strong> 
                                {% if bloqueo.hora_inicio %}
                                    de {{ bloqueo.hora_inicio|time:"H:i" }} a {{ bloqueo.hora_fin|time:"H:i" }}
                                {% else %}
                                    Día completo
                                {% endif %}
                                ({{ bloqueo.motivo|default:"Sin motivo" }})
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No tienes bloqueos programados.</p>
            {% endif %}
        </div>
    {% endif %}

{% endblock %}

{% block scripts_extra %}
    {{ block.super }} {# ¡CRUCIAL! Esto incluye el script del tour de bienvenida de la plantilla base #}

 <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- LÓGICA PARA MANEJAR EL DESCANSO Y AÑADIR NUEVAS REGLAS ---
        function setupFormCard(cardElement) {
            const descansoCheckbox = cardElement.querySelector('input[name$="-tiene_descanso"]');
            const horasDiv = cardElement.querySelector('.descanso-horas');
            
            if (descansoCheckbox && horasDiv) {
                function toggleDescanso() {
                    horasDiv.style.display = descansoCheckbox.checked ? 'grid' : 'none';
                }
                toggleDescanso();
                descansoCheckbox.addEventListener('change', toggleDescanso);
            }
        }
        
        // Aplica la lógica a todos los formularios que ya existen
        document.querySelectorAll('.regla-horario-card').forEach(setupFormCard);

        const addRuleBtn = document.getElementById('add-rule-btn');
        const container = document.getElementById('reglas-container');
        const templateNode = document.getElementById('regla-horario-template');
        const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

        if (addRuleBtn && container && templateNode && totalFormsInput) {
            addRuleBtn.addEventListener('click', function() {
                let formIdx = parseInt(totalFormsInput.value);
                
                // Clonamos el contenido del template
                let newFormHtml = templateNode.innerHTML.replace(/__prefix__/g, formIdx);
                
                // Creamos un nuevo div y le metemos el HTML clonado
                let newDiv = document.createElement('div');
                newDiv.innerHTML = newFormHtml;
                const newCard = newDiv.firstElementChild; // Obtenemos el .regla-horario-card
                
                // Añadimos el nuevo formulario al contenedor
                container.appendChild(newCard);

                totalFormsInput.value = formIdx + 1;

                // Aplicamos la lógica al nuevo formulario
                setupFormCard(newCard);
            });
        }

         const botonAyuda = document.getElementById('ayudaHorariosBtn');
    if (botonAyuda) {

        botonAyuda.addEventListener('click', function() {
            if (Shepherd.activeTour) Shepherd.activeTour.cancel();

            const tourGeneral = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shepherd-custom-theme',
                    scrollTo: true,
                    cancelIcon: { enabled: true },
                }
            });

            function startSubTourHorario(callback) {
                const subTour = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shepherd-custom-theme',
                        scrollTo: true,
                        cancelIcon: { enabled: true },
                    }
                });

                subTour.addStep({
                    title: 'Checkbox Abierto',
                    text: 'Activa o desactiva este checkbox para definir si ese día está habilitado.',
                    attachTo: { element: 'td[data-label="Abierto"] input', on: 'right' },
                    buttons: [{ text: 'Siguiente', action: subTour.next }]
                });

                subTour.addStep({
                    title: 'Horarios',
                    text: 'Define el horario de apertura y cierre.',
                    attachTo: { element: 'td[data-label="Apertura"] input', on: 'left' },
                    buttons: [{ text: 'Siguiente', action: subTour.next }]
                });

                subTour.addStep({
                    title: 'Eliminar Día',
                    text: 'Marca este checkbox y guarda para eliminar ese día.',
                    attachTo: { element: 'td[data-label="Eliminar"] input', on: 'left' },
                    buttons: [{ text: 'Finalizar', action: () => { subTour.complete(); callback(); } }]
                });

                subTour.start();
            }

            function startSubTourBloqueo(callback) {
                const subTour = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shepherd-custom-theme',
                        scrollTo: true,
                        cancelIcon: { enabled: true },
                    }
                });

                subTour.addStep({
                    title: 'Formulario de Bloqueo',
                    text: 'Completa este formulario para bloquear un día o un rango de horas.',
                    attachTo: { element: '.bloqueo-form', on: 'top' },
                    buttons: [{ text: 'Finalizar', action: () => { subTour.complete(); callback(); } }]
                });

                subTour.start();
            }

            tourGeneral.addStep({
                title: 'Configuración Semanal',
                text: 'Aquí defines los días que trabajás y tus horarios.',
                attachTo: { element: '#seccion-horario-semanal', on: 'bottom' },
                buttons: [
                    {
                        text: 'Ejemplo',
                        action: function () {
                            tourGeneral.cancel(); 
                            startSubTourHorario(() => tourGeneral.start());  
                        }
                    },
                    { text: 'Siguiente', action: tourGeneral.next }
                ]
            });

            tourGeneral.addStep({
                title: 'Bloquear Fechas',
                text: 'Aquí podés bloquear fechas o periodos especiales.',
                attachTo: { element: '#seccion-bloqueo-fechas', on: 'top' },
                buttons: [
                    {
                        text: 'Ejemplo',
                        action: function () {
                            tourGeneral.cancel();
                            startSubTourBloqueo(() => tourGeneral.start());
                        }
                    },
                    { text: 'Finalizar', action: tourGeneral.complete }
                ]
            });

            tourGeneral.start();
        });
    }

    });
    </script>
{% endblock %}