{% extends 'layouts/dashboard_base.html' %}
{% block dashboard_title %}Gestión de Turnos{% endblock %}
{% block dashboard_content %}
    <style>
        .historial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .historial-filtros a {
            text-decoration: none;
            color: #ccc;
            background-color: #3a3a3a;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .historial-filtros a.active {
            background-color: var(--color-primario, #007bff);
            color: white;
            font-weight: bold;
        }
        .pagination-container {
            margin-top: 25px;
            text-align: center;
        }
        .pagination-container a, .pagination-container span {
            color: #ccc;
            padding: 8px 12px;
            text-decoration: none;
            border: 1px solid #444;
            margin: 0 4px;
            border-radius: 5px;
        }
        .pagination-container .current-page {
            background-color: var(--color-primario, #007bff);
            color: white;
            border-color: var(--color-primario, #007bff);
        }
        .pagination-container a:hover {
            background-color: #444;
        }
    </style>
    
    {% if no_hay_servicio %}
        <div class="dashboard-section">
            <h2>Bienvenido</h2>
            <p>Aún no tienes un servicio configurado. Por favor, contacta al administrador para empezar.</p>
        </div>
    {% else %}
        <div style="display: flex; align-items: center; gap: 15px;">
        <h1>Gestión de Turnos</h1>
        <button id="ayudaGestionBtn" class="help-button" title="Ver guía de esta sección">?</button>
        </div>
        <p>Confirma o cancela las solicitudes de turnos pendientes y revisa tu agenda.</p>

        <div class="dashboard-section" id="pendiente">
            <h2>Turnos Pendientes de Confirmación</h2>
            {% if turnos_pendientes %}
                <div class="table-responsive-wrapper">
                    <table class="turnos-table responsive-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servicios Solicitados</th>
                                <th>Fecha y Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for turno in turnos_pendientes %}
                            <tr>
                                <td data-label="Cliente"><span class="data-value">{{ turno.cliente.first_name|default:turno.cliente.username }}</span></td>
                                <td data-label="Servicios">
                                    <!-- Usamos un contenedor div para aplicar Flexbox y organizar las etiquetas -->
                                    <div class="servicio-tag-container">
                                        {% for ss in turno.sub_servicios_solicitados.all %}
                                            <!-- Cada servicio será una etiqueta individual -->
                                            <span class="servicio-tag">{{ ss.nombre }}</span>
                                        {% empty %}
                                            <!-- Mensaje si no hay servicios seleccionados -->
                                            <span><em>Sin subservicios</em></span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td data-label="Fecha y Hora"><span class="data-value">{{ turno.fecha|date:"d/m/Y" }} - {{ turno.hora|time:"H:i" }}</span></td>
                                <td data-label="Acciones">
                                    <div class="action-buttons">
                                        <form action="{% url 'confirmar_turno' turno.id %}" method="post" style="display:inline;"><input type="hidden" name="servicio_id" value="{{ servicio_activo.id }}">{% csrf_token %}<button type="submit" class="btn-confirmar">Confirmar</button></form>
                                        <form action="{% url 'cancelar_turno' turno.id %}" method="post" style="display:inline;"><input type="hidden" name="servicio_id" value="{{ servicio_activo.id }}">{% csrf_token %}<button type="submit" class="btn-cancelar">Cancelar</button></form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No tienes turnos pendientes de confirmación.</p>
            {% endif %}
        </div>

        <div class="dashboard-section" id="confirmados">
            <h2>Próximos Turnos Confirmados</h2>
            {% if turnos_confirmados %}
                <div class="table-responsive-wrapper">
                    <table class="turnos-table responsive-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servicios Solicitados</th>
                                <th>Fecha y Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for turno in turnos_confirmados %}
                            <tr>
                                <td data-label="Cliente"><span class="data-value">{{ turno.cliente.first_name|default:turno.cliente.username }}</span></td>
                                <td data-label="Servicios">
                                    <div class="servicio-tag-container">
                                        {% for sub in turno.sub_servicios_solicitados.all %}
                                            <span class="servicio-tag">{{ sub.nombre }}</span>
                                        {% empty %}
                                            <span><em>Sin subservicios</em></span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td data-label="Fecha y Hora"><span class="data-value">{{ turno.fecha|date:"d/m/Y" }} - {{ turno.hora|time:"H:i" }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay próximos turnos confirmados.</p>
            {% endif %}
        </div>

        <div class="dashboard-section" id="historial">
            <div class="historial-header">
                <h2>Historial de Turnos Pasados</h2>
                <div class="historial-filtros">
                    <a href="{% url 'dashboard_turnos' %}?filtro_historial=por_finalizar" class="{% if filtro_historial_activo == 'por_finalizar' %}active{% endif %}">Para Finalizar</a>
                    <a href="{% url 'dashboard_turnos' %}?filtro_historial=finalizados" class="{% if filtro_historial_activo == 'finalizados' %}active{% endif %}">Finalizados</a>
                </div>
            </div>

            {% if historial_page_obj %}
                <div class="table-responsive-wrapper">
                    <table class="turnos-table responsive-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fecha y Hora</th>
                                <th>Estado</th>
                                <th>Ingreso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Cambiamos el bucle para que itere sobre el objeto de la página -->
                            {% for turno in historial_page_obj %}
                            <tr>
                                <td data-label="Cliente">{{ turno.cliente.first_name|default:turno.cliente.username }}</td>
                                <td data-label="Fecha y Hora">{{ turno.fecha|date:"d/m/Y" }} - {{ turno.hora|time:"H:i" }}</td>
                                <td data-label="Estado">{{ turno.get_estado_display }}</td>
                                <td data-label="Ingreso">{% if turno.ingreso_real %}${{ turno.ingreso_real|floatformat:2 }}{% else %}-{% endif %}</td>
                                <td data-label="Acciones">
                                    {% if turno.estado == 'pendiente' or turno.estado == 'confirmado' %}
                                        <a href="{% url 'finalizar_turno' turno.id %}" class="btn-confirmar"  style="color: #033f63; background-color:#b5b682; padding: 4px 3px; text-decoration: none; border-radius: 4px;">Finalizar Turno</a>
                                    {% elif turno.estado == 'completado' %}
                                        <a href="{% url 'finalizar_turno' turno.id %}" class="btn-editar-ingreso"  style="color:#b5b682 ; background-color:#033f63; padding: 4px 3px; text-decoration: none; border-radius: 4px;">Editar Ingreso</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Controles de Paginación -->
                {% if historial_page_obj.has_other_pages %}
                <div class="pagination-container">
                    {% if historial_page_obj.has_previous %}
                        <a href="?page={{ historial_page_obj.previous_page_number }}&filtro_historial={{ filtro_historial_activo }}">« Anterior</a>
                    {% endif %}

                    <span class="current-page">
                        Página {{ historial_page_obj.number }} de {{ historial_page_obj.paginator.num_pages }}
                    </span>

                    {% if historial_page_obj.has_next %}
                        <a href="?page={{ historial_page_obj.next_page_number }}&filtro_historial={{ filtro_historial_activo }}">Siguiente »</a>
                    {% endif %}
                </div>
                {% endif %}

            {% else %}
                <p>No hay historial de turnos para este filtro.</p>
            {% endif %}
        </div>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
    {{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const botonAyuda = document.getElementById('ayudaGestionBtn');
            if (botonAyuda) {
                botonAyuda.addEventListener('click', function() {
                    
                    // Si hay un tour activo (el de bienvenida), lo cerramos primero
                    if (Shepherd.activeTour) {
                        Shepherd.activeTour.cancel();
                    }

                    // Creamos una nueva instancia del tour aquí mismo
                    const tourAyuda = new Shepherd.Tour({
                        useModalOverlay: true,
                        defaultStepOptions: {
                            classes: 'shepherd-custom-theme',
                            scrollTo: true,
                            cancelIcon: { enabled: true },
                        }
                    });

                    // Añadimos los pasos
                    tourAyuda.addSteps([
                        {
                            title: 'Turnos pendientes',
                            text: 'En este bloque vas a poder aceptar o cancelar turnos que agenden usuarios.',
                            attachTo: { element: '#pendiente', on: 'bottom' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'turnos confirmados',
                            text: 'Aca vas a poder ver los turnos confirmados, con sus servicios solicitados y la techa y hora del turno.',
                            attachTo: { element: '#confirmados', on: 'top' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Historial de Turnos',
                            text: 'Aqui vas a poder ver el historial de turnos importante poner finalizar Turno para poder poner un monto generado en el turno y para que se retroalimente el dashboard de metricas.',
                            attachTo: { element: '#historial', on: 'top' },
                            buttons: [{ text: 'Finalizar', action() { return this.complete(); }}]
                        }
                    ]);
                    
                    // Iniciamos el tour
                    tourAyuda.start();
                });
            }
});
</script>
{% endblock %}