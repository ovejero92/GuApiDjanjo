{% extends 'layouts/dashboard_base.html' %}
{% load static %}
{% block dashboard_title %}M√©tricas y Reportes{% endblock %}

{% block dashboard_content %}

{% if not tiene_acceso %}
    <div class="premium-blocker-overlay" id="met">
        <div class="premium-blocker-content">
            <span class="premium-icon">üëë</span>
            <h2>Esta es una Funci√≥n Premium</h2>
            <p>
                Personaliza la apariencia de tu p√°gina y dale a tu negocio una identidad √∫nica.
                ¬°Mejora tu plan para desbloquear esta y otras funcionalidades!
            </p>
            <div class="blocker-actions">
        <a href="{% url 'precios' %}" class="btn-upgrade">Ver Planes</a>
        <a href="{% url 'dashboard_propietario' %}" class="btn-back">Volver al Dashboard</a>
    </div>
        </div>
    </div>
{% endif %}


<div id="seccion-metricas">
    <div class="metricas-header" >
        <div class="title-metricas">
                <h1>M√©tricas y Reportes</h1>
                <button id="ayudaMetricasBtn" class="help-button" title="Ver gu√≠a de esta secci√≥n">?</button>
        </div>
        <div class="periodo-filtro">
            <a href="?periodo=7d" class="btn-filtro {% if periodo_seleccionado == '7d' %}active{% endif %}">7 D√≠as</a>
            <a href="?periodo=30d" class="btn-filtro {% if periodo_seleccionado == '30d' %}active{% endif %}">30 D√≠as</a>
            <a href="?periodo=mes_actual" class="btn-filtro {% if periodo_seleccionado == 'mes_actual' %}active{% endif %}">Este Mes</a>
            <a href="?periodo=a√±o_actual" class="btn-filtro {% if periodo_seleccionado == 'a√±o_actual' %}active{% endif %}">Este A√±o</a>
        </div>
    </div>

    <h2 class="subtitulo-periodo">{{ titulo_periodo }}</h2>
    <div class="metric-cards" id="tarjetas-kpi">
        <div class="metric-card" id="IT"><h3>Ingresos Totales</h3><p class="metric-value">${{ ingresos_totales|floatformat:2 }}</p></div>
        <div class="metric-card" id="TC"><h3>Turnos Completados</h3><p class="metric-value">{{ turnos_totales }}</p></div>
        <div class="metric-card" id="IP"><h3>Ingreso Promedio / Turno</h3><p class="metric-value">${{ ingreso_promedio|floatformat:2 }}</p></div>
        <div class="metric-card" id="MC">
            <h3>Mejor Cliente</h3>
            {% if cliente_top and cliente_top.total_gastado > 0 %}
            <div class="cliente-info-trigger"
            style="cursor: pointer; text-decoration: underline; color: #10a4ff;"
            title="Haz clic para ver detalles"
            data-nombre="{{ cliente_top.cliente__first_name|default:'' }}"
            data-apellido="{{ cliente_top.cliente__last_name|default:'' }}"
            data-email="{{ cliente_top.cliente__email|default:'No especificado' }}"
            data-telefono="{{ cliente_top.cliente__telefono|default:'No especificado' }}">
            <p class="metric-value" style="font-size: 1.5em; line-height: 1.2; color: #10a4ff;">
            {{ cliente_top.cliente__first_name|default:'' }} {{ cliente_top.cliente__last_name|default:'' }}
        </p>
    </div>
    <small style="color: #aaa;">Total: ${{ cliente_top.total_gastado|floatformat:2 }}</small>
{% else %}
    <p class="metric-value">-</p>
{% endif %}
        </div>
    </div>

     <div class="charts-grid" id="zona-graficos">
        <div class="dashboard-section chart-container" id="GID">
            <div class="chart-header">
                <h2>An√°lisis de Ingresos</h2>
                <div class="chart-controls">
                    <button class="control-btn active" data-agrupar="dia">D√≠a</button>
                    <button class="control-btn" data-agrupar="mes">Mes</button>
                    <button class="control-btn" data-agrupar="a√±o">A√±o</button>
                    <input type="date" id="filtro-dia" class="filtro-fecha" placeholder="dd/mm/aaaa" value="">
                    <input type="month" id="filtro-mes" class="filtro-fecha" style="display: none;">
                    <input type="number" id="filtro-a√±o" class="filtro-fecha" style="display: none;" min="2020" max="2050" step="1">
                     {% if es_propietario_prime %}
                        <div class="vista-grafico-switch" style="margin-left: 15px; border-left: 2px solid #555; padding-left: 15px;">
                            <button class="control-btn active" data-vista="total">Total</button>
                            <button class="control-btn" data-vista="profesional">Por Profesional</button>
                        </div>
                    {% endif %}
                </div>
            </div>
<canvas id="ingresosChart" data-api-url="{% url 'api_metricas_grafico' %}"></canvas>
        </div>
        <div class="dashboard-section chart-container" id="SP">
            <h2>Servicios Populares (Total)</h2>
            <canvas id="serviciosPopularesChart" ></canvas>
        </div>
    </div>

    {% if es_propietario_prime %}
    <div class="dashboard-section" id="metricas-profesionales" style="margin-top: 20px;">
        <div class="chart-header">
            <h2>Rendimiento por Profesional</h2>
        </div>
        {% if metricas_por_profesional %}
            <div class="table-responsive-wrapper">
                <!-- Reutilizamos tus clases para mantener la est√©tica -->
                <table class="turnos-table responsive-table">
                    <thead>
                        <tr>
                            <th>Profesional</th>
                            <th>Ingresos Generados</th>
                            <th>Turnos Atendidos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for metrica in metricas_por_profesional %}
                        <tr>
                            <td data-label="Profesional"><span class="data-value">{{ metrica.profesional__nombre }}</span></td>
                            <td data-label="Ingresos"><span class="data-value">${{ metrica.total_ingresos|floatformat:2 }}</span></td>
                            <td data-label="Turnos"><span class="data-value">{{ metrica.cantidad_turnos }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p style="text-align: center; color: #aaa; padding: 20px 0;">No hay datos de rendimiento de profesionales para el per√≠odo seleccionado.</p>
        {% endif %}
    </div>
    {% endif %}
</div>
    
{{ labels_servicios_json|json_script:"labels-servicios-data" }}
{{ data_servicios_json|json_script:"data-servicios-data" }}
    {% endblock %}


{% block scripts_extra %}
    {{ block.super }}
    <script>
        document.addEventListener('turbolinks:load', function() {
            
            const seccionMetricas = document.getElementById('seccion-metricas');
            if (!seccionMetricas) return;

            // Destrucci√≥n preventiva
            if (window.doughnutChart) { window.doughnutChart.destroy(); }
            if (window.lineChart) { window.lineChart.destroy(); }
            
            // --- GR√ÅFICO 1: SERVICIOS POPULARES (C√ìDIGO COMPLETO) ---
            try {
                const labelsServicios = JSON.parse(document.getElementById('labels-servicios-data').textContent);
                const dataServicios = JSON.parse(document.getElementById('data-servicios-data').textContent);
                const canvasServicios = document.getElementById('serviciosPopularesChart');
                
                if (canvasServicios && Array.isArray(labelsServicios) && Array.isArray(dataServicios) && dataServicios.length > 0) {
                    window.doughnutChart = new Chart(canvasServicios.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: labelsServicios,
                            datasets: [{ data: dataServicios, backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                } else if (canvasServicios) {
                    const ctx = canvasServicios.getContext('2d');
                    ctx.clearRect(0, 0, canvasServicios.width, canvasServicios.height);
                    ctx.textAlign = 'center'; ctx.font = '14px Segoe UI'; ctx.fillStyle = '#888';
                    ctx.fillText('No hay datos de servicios para este per√≠odo.', canvasServicios.width / 2, canvasServicios.height / 2);
                }
            } catch (e) { console.error("Error en gr√°fico de torta:", e); }

            // --- GR√ÅFICO 2: AN√ÅLISIS DE INGRESOS (C√ìDIGO COMPLETO) ---
            const canvasIngresos = document.getElementById('ingresosChart');
            window.lineChart = new Chart(canvasIngresos.getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // Selectores
            const controlesAgrupacion = document.querySelectorAll('.control-btn[data-agrupar]');
            const controlesVista = document.querySelectorAll('.control-btn[data-vista]');
            const filtrosFecha = document.querySelectorAll('.filtro-fecha');
            
            // Estado
            let estadoGrafico = {
                agrupacion: 'dia',
                vista: 'total'
            };

            function actualizarGraficoLineal() {
                const apiUrl = canvasIngresos.dataset.apiUrl;
                if (!apiUrl) return;

                const filtroDia = document.getElementById('filtro-dia');
                const filtroMes = document.getElementById('filtro-mes');
                const filtroA√±o = document.getElementById('filtro-a√±o');
                
                let params = new URLSearchParams({
                    agrupar_por: estadoGrafico.agrupacion,
                    vista: estadoGrafico.vista
                });

                if (estadoGrafico.agrupacion === 'dia') params.append('fecha', filtroDia.value);
                if (estadoGrafico.agrupacion === 'mes') params.append('mes', filtroMes.value);
                if (estadoGrafico.agrupacion === 'a√±o') params.append('a√±o', filtroA√±o.value);
                
                fetch(`${apiUrl}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.json())
                .then(data => {
                    if (window.lineChart) {
                        window.lineChart.data.labels = data.labels;
                        window.lineChart.data.datasets = data.datasets.map(ds => ({
                            ...ds,
                            fill: true,
                            tension: 0.1
                        }));
                        window.lineChart.options.plugins.legend.display = data.datasets.length > 1;
                        window.lineChart.update();
                    }
                });
            }

            // Listeners
            controlesAgrupacion.forEach(btn => {
                btn.addEventListener('click', function() {
                    estadoGrafico.agrupacion = this.dataset.agrupar;
                    controlesAgrupacion.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filtrosFecha.forEach(f => f.style.display = 'none');
                    document.getElementById(`filtro-${estadoGrafico.agrupacion}`).style.display = 'block';
                    actualizarGraficoLineal();
                });
            });

            controlesVista.forEach(btn => {
                btn.addEventListener('click', function() {
                    estadoGrafico.vista = this.dataset.vista;
                    controlesVista.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    actualizarGraficoLineal();
                });
            });

            filtrosFecha.forEach(filtro => {
                filtro.addEventListener('change', actualizarGraficoLineal);
            });

            // Carga inicial
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            document.getElementById('filtro-dia').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('filtro-mes').value = `${yyyy}-${mm}`;
            document.getElementById('filtro-a√±o').value = yyyy;
            
            actualizarGraficoLineal();
            
            // C√≥digo del tour de ayuda
            const botonAyuda = document.getElementById('ayudaMetricasBtn');
            if (botonAyuda) {
                botonAyuda.addEventListener('click', function() {
                    
                    if (Shepherd.activeTour) {
                        Shepherd.activeTour.cancel();
                    }

                    const tourAyuda = new Shepherd.Tour({
                        useModalOverlay: true,
                        defaultStepOptions: {
                            classes: 'shepherd-custom-theme',
                            scrollTo: true,
                            cancelIcon: { enabled: true },
                        }
                    });

                    tourAyuda.addSteps([
                        {
                            title: 'Filtros de Per√≠odo',
                            text: 'Usa estos botones para ver tus estad√≠sticas en diferentes rangos de tiempo.',
                            attachTo: { element: '.periodo-filtro', on: 'bottom' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Igresos totales',
                            text: 'Aqu√≠ tienes ingresos totales de todos los turnos.',
                            attachTo: { element: '#IT', on: 'right' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Turnos completados',
                            text: 'Aqu√≠ veras todos los turnos completados hasta la fecha',
                            attachTo: { element: '#TC', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Ingreso promedio',
                            text: 'Esto sera un promedio en $ de todos los turnos completados',
                            attachTo: { element: '#IP', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Servicios populares',
                            text: 'Aqu√≠ veras los servicios que mas turnos tienen',
                            attachTo: { element: '#SP', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Grafico ingresos por dia',
                            text: 'Aca veras como va los graficos del dia',
                            attachTo: { element: '#GID', on: 'top' },
                            buttons: [{ text: 'Finalizar', action() { return this.complete(); }}]
                        }
                    ]);
                    
                    tourAyuda.start();
                });
            }

            const mejorClienteTrigger = document.querySelector('#MC .cliente-info-trigger');

            if (mejorClienteTrigger) {
                mejorClienteTrigger.addEventListener('click', function() {
                    const nombre = this.dataset.nombre;
                    const apellido = this.dataset.apellido;
                    const email = this.dataset.email;
                    const telefono = this.dataset.telefono;
                
                    const modalContent = `
                        <div style="text-align: left; padding: 0 1rem;">
                            <p><strong>Nombre:</strong> ${nombre} ${apellido}</p>
                            <p><strong>Email:</strong> ${email}</p>
                            <p><strong>Tel√©fono:</strong> ${telefono}</p>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: '<strong>Informaci√≥n del Cliente</strong>',
                        icon: 'info',
                        html: modalContent,
                        showCloseButton: true,
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#033f63',
                    });
                });
            }
        });
    </script>
    <script>
        
            
    </script>
{% endblock %}