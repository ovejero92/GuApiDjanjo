{% extends 'layouts/dashboard_base.html' %}
{% load static %}
{% block dashboard_title %}M칠tricas y Reportes{% endblock %}

{% block dashboard_content %}

{% if not tiene_acceso %}
    <div class="premium-blocker-overlay" id="met">
        <div class="premium-blocker-content">
            <span class="premium-icon">游녬</span>
            <h2>Esta es una Funci칩n Premium</h2>
            <p>
                Personaliza la apariencia de tu p치gina y dale a tu negocio una identidad 칰nica.
                춰Mejora tu plan para desbloquear esta y otras funcionalidades!
            </p>
            <div class="blocker-actions">
        <a href="{% url 'precios' %}" class="btn-upgrade">Ver Planes</a>
        <a href="{% url 'dashboard_propietario' %}" class="btn-back">Volver al Dashboard</a>
    </div>
        </div>
    </div>
{% endif %}


<div id="seccion-metricas">
    <div class="metricas-header" >
        <div class="title-metricas">
                <h1>M칠tricas y Reportes</h1>
                <button id="ayudaMetricasBtn" class="help-button" title="Ver gu칤a de esta secci칩n">?</button>
        </div>
        <div class="periodo-filtro">
            <a href="?periodo=7d" class="btn-filtro {% if periodo_seleccionado == '7d' %}active{% endif %}">7 D칤as</a>
            <a href="?periodo=30d" class="btn-filtro {% if periodo_seleccionado == '30d' %}active{% endif %}">30 D칤as</a>
            <a href="?periodo=mes_actual" class="btn-filtro {% if periodo_seleccionado == 'mes_actual' %}active{% endif %}">Este Mes</a>
            <a href="?periodo=a침o_actual" class="btn-filtro {% if periodo_seleccionado == 'a침o_actual' %}active{% endif %}">Este A침o</a>
        </div>
    </div>

    <h2 class="subtitulo-periodo">{{ titulo_periodo }}</h2>
    <div class="metric-cards" id="tarjetas-kpi">
        <div class="metric-card" id="IT"><h3>Ingresos Totales</h3><p class="metric-value">${{ ingresos_totales|floatformat:2 }}</p></div>
        <div class="metric-card" id="TC"><h3>Turnos Completados</h3><p class="metric-value">{{ turnos_totales }}</p></div>
        <div class="metric-card" id="IP"><h3>Ingreso Promedio / Turno</h3><p class="metric-value">${{ ingreso_promedio|floatformat:2 }}</p></div>
    </div>

     <div class="charts-grid" id="zona-graficos">
        <div class="dashboard-section chart-container" id="GID">
            <div class="chart-header">
                <h2>An치lisis de Ingresos</h2>
                <div class="chart-controls">
                    <button class="control-btn active" data-agrupar="dia">D칤a</button>
                    <button class="control-btn" data-agrupar="mes">Mes</button>
                    <button class="control-btn" data-agrupar="a침o">A침o</button>
                    <input type="date" id="filtro-dia" class="filtro-fecha">
                    <input type="month" id="filtro-mes" class="filtro-fecha" style="display: none;">
                    <input type="number" id="filtro-a침o" class="filtro-fecha" style="display: none;" min="2020" max="2050" step="1">
                </div>
            </div>
            <canvas id="ingresosChart"></canvas>
        </div>
        <div class="dashboard-section chart-container" id="SP">
            <h2>Servicios Populares (Total)</h2>
            <canvas id="serviciosPopularesChart"></canvas>
        </div>
    </div>
</div>
    
{{ labels_servicios_json|json_script:"labels-servicios-data" }}
{{ data_servicios_json|json_script:"data-servicios-data" }}
    {% endblock %}

    {% block scripts_extra %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const labelsServicios = JSON.parse(document.getElementById('labels-servicios-data').textContent);
                const dataServicios = JSON.parse(document.getElementById('data-servicios-data').textContent);
                const canvasServicios = document.getElementById('serviciosPopularesChart');
                if (canvasServicios && Array.isArray(labelsServicios) && Array.isArray(dataServicios) && dataServicios.length > 0) {
                    new Chart(canvasServicios.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: labelsServicios,
                            datasets: [{
                                label: 'N췈 de Turnos',
                                data: dataServicios,
                                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1']
                            }]
                        }
                    });
                } else if (canvasServicios) {
                    const ctx = canvasServicios.getContext('2d');
                    ctx.textAlign = 'center'; ctx.font = '14px Segoe UI'; ctx.fillStyle = '#888';
                    ctx.fillText('No hay datos de servicios populares.', canvasServicios.width / 2, canvasServicios.height / 2);
                }
            } catch (e) { console.error("Error en gr치fico de servicios:", e); }


            const ctxIngresos = document.getElementById('ingresosChart').getContext('2d');
            let ingresosChart = new Chart(ctxIngresos, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Ingresos ($)', data: [], borderColor: 'aqua', backgroundColor: 'rgba(0, 255, 255, 0.2)', fill: true, tension: 0.1 }] },
                options: { scales: { y: { beginAtZero: true } } }
            });

            const controles = document.querySelectorAll('.control-btn');
            const filtrosFecha = document.querySelectorAll('.filtro-fecha');
            const filtroDia = document.getElementById('filtro-dia');
            const filtroMes = document.getElementById('filtro-mes');
            const filtroA침o = document.getElementById('filtro-a침o');
            let agrupacionActual = 'dia';

            async function actualizarGrafico() {
                let params = new URLSearchParams({ agrupar_por: agrupacionActual });
                if (agrupacionActual === 'dia') params.append('fecha', filtroDia.value);
                if (agrupacionActual === 'mes') params.append('mes', filtroMes.value);
                if (agrupacionActual === 'a침o') params.append('a침o', filtroA침o.value);
                
                try {
                    const response = await fetch(`{% url 'dashboard_metricas' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    const data = await response.json();
                    
                    ingresosChart.data.labels = data.labels;
                    ingresosChart.data.datasets[0].data = data.data;
                    ingresosChart.update();
                } catch (e) { console.error("Error al actualizar el gr치fico:", e); }
            }

            controles.forEach(btn => btn.addEventListener('click', function() {
                agrupacionActual = this.dataset.agrupar;
                controles.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                filtrosFecha.forEach(f => f.style.display = 'none');
                document.getElementById(`filtro-${agrupacionActual}`).style.display = 'block';
                actualizarGrafico();
            }));
            filtrosFecha.forEach(filtro => filtro.addEventListener('change', actualizarGrafico));
            
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            filtroDia.value = `${yyyy}-${mm}-${dd}`;
            filtroMes.value = `${yyyy}-${mm}`;
            filtroA침o.value = yyyy;
            
            actualizarGrafico();

            const botonAyuda = document.getElementById('ayudaMetricasBtn');
            if (botonAyuda) {
                botonAyuda.addEventListener('click', function() {
                    
                    if (Shepherd.activeTour) {
                        Shepherd.activeTour.cancel();
                    }

                    const tourAyuda = new Shepherd.Tour({
                        useModalOverlay: true,
                        defaultStepOptions: {
                            classes: 'shepherd-custom-theme',
                            scrollTo: true,
                            cancelIcon: { enabled: true },
                        }
                    });

                    tourAyuda.addSteps([
                        {
                            title: 'Filtros de Per칤odo',
                            text: 'Usa estos botones para ver tus estad칤sticas en diferentes rangos de tiempo.',
                            attachTo: { element: '.periodo-filtro', on: 'bottom' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Igresos totales',
                            text: 'Aqu칤 tienes ingresos totales de todos los turnos.',
                            attachTo: { element: '#IT', on: 'right' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Turnos completados',
                            text: 'Aqu칤 veras todos los turnos completados hasta la fecha',
                            attachTo: { element: '#TC', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Ingreso promedio',
                            text: 'Esto sera un promedio en $ de todos los turnos completados',
                            attachTo: { element: '#IP', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Servicios populares',
                            text: 'Aqu칤 veras los servicios que mas turnos tienen',
                            attachTo: { element: '#SP', on: 'left' },
                            buttons: [{ text: 'Siguiente', action() { return this.next(); }}]
                        },
                        {
                            title: 'Grafico ingresos por dia',
                            text: 'Aca veras como va los graficos del dia',
                            attachTo: { element: '#GID', on: 'top' },
                            buttons: [{ text: 'Finalizar', action() { return this.complete(); }}]
                        }
                    ]);
                    
                    tourAyuda.start();
                });
            }
        });
    </script>
{% endblock %}