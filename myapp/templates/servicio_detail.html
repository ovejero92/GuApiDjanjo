{% extends 'layouts/navbar.html' %}
{% load static %}
{% block body_class %}pagina-servicio-personalizada{% endblock %}
{% block title %}{{ servicio.nombre }} en Turnos Online{% endblock %}
{% block meta_description %}Reserva tu turno en {{ servicio.nombre }}. {{ servicio.descripcion|truncatewords:20 }}{% endblock %}
{% load custom_filters %}
{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat&family=Open+Sans&family=Playfair+Display&family=Roboto&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% block styles_extra %}
<style>
    :root {
        --color-primario-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_primario }}{% else %}#007bff{% endif %};
        --color-fondo-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_fondo }}{% else %}#343a40{% endif %};
        --color-texto-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_texto }}{% else %}#ffffff{% endif %};
        --fuente-titulos: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.fuente_titulos }}{% else %}'Montserrat', sans-serif{% endif %};
        --fuente-cuerpo: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.fuente_cuerpo }}{% else %}'Roboto', sans-serif{% endif %};
        --color-slot-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_slot }}{% else %}#4A4A4A{% endif %};
        --color-slot-seleccionado-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_slot_seleccionado }}{% else %}#28a745{% endif %};
    }
</style>
{% endblock %}

{% if servicio.imagen_banner and servicio.tiene_apariencia_premium_activa %}
    <div class="banner-servicio" style="background-image: url('{{ servicio.imagen_banner.url }}');"></div>
{% endif %}


<div class="container">
    <div class="turno-form-container" {% if servicio.imagen_banner %}style="margin-top: 20px;"{% endif %}>
        <h1>Solicitar turno para: {{ servicio.nombre }}</h1>
        <p>{{ servicio.descripcion }}</p>
        
        <form method="post" id="turnoForm">
            {% csrf_token %}
            {% if form.non_field_errors %}<div class="form-error">{{ form.non_field_errors|join:", " }}</div>{% endif %}
            
            <div class="form-group">
                <label>1. Elige los servicios que deseas:</label>
                <div id="subservicios-list">
                    {% for subservicio in servicio.sub_servicios.all %}
                        <div class="subservicio-item" data-id="{{ subservicio.id }}" data-duracion="{{ subservicio.duracion }}" data-precio="{{ subservicio.precio }}" title="{{ subservicio.descripcion }}">
                            <div class="subservicio-info">
                                <strong>{{ subservicio.nombre }}</strong>
                                <i class="fas fa-info-circle info-icon" data-descripcion="{{ subservicio.descripcion|escapejs }}" data-nombre="{{ subservicio.nombre|escapejs }}"></i>
                            </div>
                            <span>({{ subservicio.duracion }} min) - ${{ subservicio.precio|floatformat:2 }}</span>
                        </div>
                    {% empty %}
                        <p>Este negocio aún no ha cargado su catálogo de servicios.</p>
                    {% endfor %}
                </div>
                <div style="display:none;">{{ form.sub_servicios_solicitados }}</div>
            </div>

            <div id="resumen-turno"  style="display: none;">
                <p><strong>Duración Total:</strong> <span id="duracion-total">0</span> minutos</p>
                <p><strong>Precio Total Estimado:</strong> $<span id="precio-total">0.00</span></p>
            </div>

            {% if servicio.permite_multiples_profesionales %}
                <div class="form-group mt-4">
                    <label for="profesional-select">Elige con quién atenderte:</label>
                    <select id="profesional-select" name="profesional_id" class="form-control">
                        <option value="">Selecciona un profesional...</option>
                        {% for prof in profesionales %}
                    <option value="{{ prof.id }}">{{ prof.nombre }}</option>
                {% endfor %}
                    </select>
                </div>
                {% else %}
                <input type="hidden" name="profesional_id" value="{{ servicio.profesionales.first.id }}">
            {% endif %}
            
            <div id="reserva-pasos-siguientes" style="display: none;">
                <div class="form-group">
                    <label for="id_fecha">2. Selecciona una fecha:</label>
                    {{ form.fecha }}
                </div>
                <div class="form-group">
                    <label>3. Elige un horario disponible:</label>
                    <div id="slotsContainer" class="slots-container"></div>
                </div>
                <div class="form-group">
                    <label for="id_medio_de_pago">4. ¿Cómo deseas pagar?</label>
                    {{ form.medio_de_pago }}
                </div>
            </div>
            
            {{ form.hora.as_hidden }}
            <button type="submit" class="btn-submit is-disabled" id="boton-premiun">Solicitar Turno</button>
        </form>
    </div>

    <div class="reseñas-container" id="seccion-reseñas">
    <h2>Opiniones de Nuestros Clientes</h2>
    
    {% if calificacion_promedio %}
        <div class="resumen-calificacion">
            <span class="promedio-numero">{{ calificacion_promedio|floatformat:1 }}</span>
            <span class="promedio-estrellas">
            </span>
            <span class="total-reseñas">(basado en {{ conteo_total_reseñas }} reseñas)</span>
        </div>

        <div class="filtros-reseñas">
            <a href="{% url 'servicio_detail' servicio.slug %}" class="filtro-btn {% if not filtro_activo %}active{% endif %}">Todas ({{ conteo_total_reseñas }})</a>
            {% for i in "54321"|make_list %}
                {% with star_count=conteo_estrellas|get_item:i|default:0 %}
                <a href="?calificacion={{ i }}" class="filtro-btn {% if filtro_activo == i|add:0 %}active{% endif %}">
                    {{ i }} <i class="fas fa-star"></i> ({{ star_count }})
                </a>
                {% endwith %}
            {% endfor %}
        </div>

        <div id="lista-reseñas" class="lista-reseñas">
            {% for reseña in reseñas %}
                <div class="reseña-card">
                    <div class="reseña-header">
                        <span class="reseña-usuario">{{ reseña.usuario.username }}</span>
                        <span class="reseña-fecha">{{ reseña.fecha_creacion|date:"d/m/Y" }}</span>
                    </div>
                    <div class="reseña-calificacion">
                        {% for i in "12345"|make_list %}{% if reseña.calificacion >= i|add:0 %}<i class="fas fa-star"></i>{% endif %}{% endfor %}
                    </div>
                    <p class="reseña-comentario">{{ reseña.comentario|linebreaksbr }}</p>
                </div>
            {% empty %}
                <p>No hay reseñas que coincidan con este filtro.</p>
            {% endfor %}
        </div>
        
        {% if tiene_mas_paginas %}
        <div class="load-more-container">
            <button id="load-more-reviews" class="btn-load-more">Cargar más reseñas</button>
        </div>
        {% endif %}

    {% else %}
        <p>Este servicio aún no tiene reseñas. ¡Sé el primero en dejar una!</p>
    {% endif %}
</div>

<footer class="footer-estructurado">
    <div class="container footer-grid">
        
        <div class="footer-columna footer-mapa">
            <h4>Ubicación</h4>
            {% if servicio.footer_direccion and google_maps_api_key %}
                <div class="map-container" style="text-align: center;">
                    <iframe
                        width="90%"
                        height="200"
                        style="border:0; border-radius: 8px;"
                        loading="lazy"
                        allowfullscreen
                        src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q={{ servicio.footer_direccion|urlencode }}">
                    </iframe>
                </div>
            {% else %}
                <p>La dirección no ha sido especificada por el propietario.</p>
            {% endif %}
        </div>

        <div class="footer-columna">
            <h4>Contacto</h4>
            {% if servicio.footer_direccion %}<p><i class="fas fa-map-marker-alt"></i> {{ servicio.footer_direccion }}</p>{% endif %}
            {% if servicio.footer_telefono %}<p><i class="fas fa-phone"></i> {{ servicio.footer_telefono }}</p>{% endif %}
            {% if servicio.footer_email %}<p><i class="fas fa-envelope"></i> {{ servicio.footer_email }}</p>{% endif %}
        </div>

        <div class="footer-columna">
            <h4>Síguenos en Redes</h4>
            <div class="social-links">
                {% if servicio.footer_facebook_url %}
                    <a href="https://www.facebook.com/{{ servicio.footer_facebook_url }}" target="_blank"><i class="fab fa-facebook-f"></i></a>
                {% endif %}
                {% if servicio.footer_instagram_url %}
                    <a href="https://www.instagram.com/{{ servicio.footer_instagram_url }}" target="_blank"><i class="fab fa-instagram"></i></a>
                {% endif %}
                {% if servicio.footer_tiktok_url %}
                    <a href="https://www.tiktok.com/{{ servicio.footer_tiktok_url }}" target="_blank"><i class="fab fa-tiktok"></i></a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>© {% now "Y" %} {{ servicio.nombre }}. Todos los derechos reservados.</p>
    </div>
</footer>

{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Tus selectores existentes (están perfectos) ---
    const subserviciosItems = document.querySelectorAll('.subservicio-item');
    const duracionTotalDisplay = document.getElementById('duracion-total');
    const precioTotalDisplay = document.getElementById('precio-total');
    const resumenDiv = document.getElementById('resumen-turno');
    const reservaPasosDiv = document.getElementById('reserva-pasos-siguientes');
    const fechaInput = document.getElementById('id_fecha');
    const horaInput = document.getElementById('id_hora');
    const slotsContainer = document.getElementById('slotsContainer');
    const submitButton = document.querySelector('button.btn-submit');
    const formCheckboxes = document.querySelectorAll('input[name="sub_servicios_solicitados"]');
    
    // --- Selector de Profesional: ahora más genérico para capturar ambos casos ---
    // Intentará encontrar el <select> (Prime) o el <input type="hidden"> (Free)
    const profesionalInput = document.querySelector('[name="profesional_id"]');

    let duracionTotalCalculada = 0;
    let selectedSlotButton = null;

    // --- Tu función `actualizarResumenYPasos` (está perfecta, no se toca) ---
    function actualizarResumenYPasos() {
        let duracionTotal = 0;
        let precioTotal = 0.0;
        let seleccionados = [];
        subserviciosItems.forEach(item => {
            if (item.classList.contains('selected')) {
                duracionTotal += parseInt(item.dataset.duracion, 10);
                precioTotal += parseFloat(item.dataset.precio);
                seleccionados.push(item.dataset.id);
            }
        });
        formCheckboxes.forEach(cb => { cb.checked = seleccionados.includes(cb.value); });
        duracionTotalCalculada = duracionTotal;
        duracionTotalDisplay.textContent = duracionTotal;
        precioTotalDisplay.textContent = precioTotal.toFixed(2);
        if (duracionTotal > 0) {
            resumenDiv.style.display = 'block';
            reservaPasosDiv.style.display = 'block';
            if (fechaInput.value) {
                cargarSlots(); // Llamamos sin argumentos, la función los tomará
            }
        } else {
            resumenDiv.style.display = 'none';
            reservaPasosDiv.style.display = 'none';
            submitButton.classList.add('is-disabled');
        }
    }

    // --- Función `cargarSlots` (¡AQUÍ ESTÁ LA CORRECCIÓN MÁS IMPORTANTE!) ---
    async function cargarSlots() {
        // Limpiamos el estado anterior
        slotsContainer.innerHTML = '<p>Buscando horarios...</p>';
        submitButton.classList.add('is-disabled');
        selectedSlotButton = null;
        horaInput.value = '';
        
        // 1. Obtenemos los valores DIRECTAMENTE dentro de la función
        const fecha = fechaInput.value;
        const duracion = duracionTotalCalculada;
        const profesionalId = profesionalInput.value;

        // 2. Validación robusta que funciona para AMBOS casos
        if (!fecha || !duracion || !profesionalId) {
            if (profesionalInput.tagName === 'SELECT' && !profesionalId) {
                 slotsContainer.innerHTML = '<p class="text-info">Por favor, elige un profesional para ver sus horarios.</p>';
            } else {
                 slotsContainer.innerHTML = '<p class="text-info">Elige un servicio y una fecha.</p>';
            }
            return; // No continuamos si falta algo
        }

        try {
            // 3. La URL se construye siempre de la misma manera
            const url = `/api/slots-disponibles/{{ servicio.id }}/?fecha=${fecha}&duracion=${duracion}&profesional_id=${profesionalId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Respuesta del servidor no fue OK');
            const data = await response.json();
            
            slotsContainer.innerHTML = '';
            if (data.mensaje) {
                slotsContainer.innerHTML = `<p class="text-info">${data.mensaje}</p>`;
            } else if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'slot-button';
                    button.textContent = slot;
                    button.dataset.hora = slot;
                    button.addEventListener('click', function() {
                        if (selectedSlotButton) { selectedSlotButton.classList.remove('selected'); }
                        this.classList.add('selected');
                        selectedSlotButton = this;
                        horaInput.value = this.dataset.hora;
                        submitButton.classList.remove('is-disabled');
                    });
                    slotsContainer.appendChild(button);
                });
            } else {
                slotsContainer.innerHTML = '<p>No hay horarios disponibles para esta combinación.</p>';
            }
        } catch (error) {
            console.error("Error al cargar slots:", error);
            slotsContainer.innerHTML = '<p style="color:red;">Error al cargar horarios. Intenta de nuevo.</p>';
        }
    }
    
    // --- Lógica del Calendario (Eliminamos la dependencia del JSON) ---
    // Tu calendario ya no necesita `horario_trabajo_json` ni `fechas_ocupadas_json`
    // porque la API hace todo el trabajo pesado.
    flatpickr(fechaInput, {
        altInput: true,
        altFormat: "F j, Y",
        dateFormat: "Y-m-d",
        minDate: "today",
        locale: "es",
        // Ya no necesitamos la lógica 'enable'. El calendario muestra todos los días,
        // y si un día no tiene slots, la API nos lo dirá.
        onChange: function(selectedDates, dateStr, instance) {
            submitButton.classList.add('is-disabled');
            if (dateStr && duracionTotalCalculada > 0) {
                cargarSlots(); // Llamamos sin argumentos
            }
        },
    });

    // --- Lógica de Eventos (Ahora más simple y robusta) ---

    // El selector de profesional (si es visible) dispara la carga de slots
    if (profesionalInput && profesionalInput.tagName === 'SELECT') {
        profesionalInput.addEventListener('change', function() {
            if (fechaInput.value && duracionTotalCalculada > 0) {
                cargarSlots();
            }
        });
    }

    // Los subservicios disparan la actualización general
    subserviciosItems.forEach(item => {
        item.addEventListener('click', function() {
            this.classList.toggle('selected');
            actualizarResumenYPasos();
        });
    });

    // --- Inicialización y Lógica de íconos (se queda igual) ---
    actualizarResumenYPasos();

    const infoIcons = document.querySelectorAll('.info-icon');
    infoIcons.forEach(icon => {
        icon.addEventListener('click', function(event) {
            event.stopPropagation();
            const descripcion = event.currentTarget.dataset.descripcion;
            const nombre = event.currentTarget.dataset.nombre;
            if (descripcion) {
                Swal.fire({
                    title: nombre, text: descripcion, icon: 'info', confirmButtonText: 'Entendido'
                });
            }
        });
    });
});
</script>
 <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadMoreButton = document.getElementById('load-more-reviews');
        const reviewsContainer = document.getElementById('lista-reseñas');
        
        if (!loadMoreButton) return;

        let currentPage = 2;
        const urlParams = new URLSearchParams(window.location.search);
        const calificacionFiltro = urlParams.get('calificacion') || '';

        function generateStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<i class="fas fa-star"></i>';
                }
            }
            return starsHtml;
        }

        async function loadMoreReviews() {
            loadMoreButton.textContent = 'Cargando...';
            loadMoreButton.disabled = true;

            const apiUrl = `/api/reseñas/{{ servicio.slug }}/?page=${currentPage}&calificacion=${calificacionFiltro}`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                data.reseñas.forEach(reseña => {
                    const reviewCardHTML = `
                        <div class="reseña-card">
                            <div class="reseña-header">
                                <span class="reseña-usuario">${reseña.usuario}</span>
                                <span class="reseña-fecha">${reseña.fecha_creacion}</span>
                            </div>
                            <div class="reseña-calificacion">${generateStars(reseña.calificacion)}</div>
                            <p class="reseña-comentario">${reseña.comentario.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                    reviewsContainer.insertAdjacentHTML('beforeend', reviewCardHTML);
                });

                if (data.has_next_page) {
                    currentPage++;
                    loadMoreButton.textContent = 'Cargar más reseñas';
                    loadMoreButton.disabled = false;
                } else {
                    loadMoreButton.style.display = 'none';
                }
            } catch (error) {
                console.error('Error al cargar más reseñas:', error);
                loadMoreButton.textContent = 'Error al cargar. Reintentar.';
                loadMoreButton.disabled = false;
            }
        }

        loadMoreButton.addEventListener('click', loadMoreReviews);
    });
    </script>
{% endblock %}