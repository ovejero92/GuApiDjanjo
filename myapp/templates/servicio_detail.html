{% extends 'layouts/navbar.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="turno-form-container">
        <h1>Solicitar turno para: {{ servicio.nombre }}</h1>
        <p>{{ servicio.descripcion }}</p>
        <p>Duración aproximada: {{ servicio.duracion }} minutos.</p>

        <form method="post" id="turnoForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="form-error">{{ form.non_field_errors }}</div>
            {% endif %}
            
            <div class="form-group">
                <label for="id_fecha">1. Selecciona una fecha:</label>
                {{ form.fecha }}
                {% if form.fecha.errors %}<div class="form-error">{{ form.fecha.errors }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label>2. Elige un horario disponible:</label>
                <div id="slotsContainer" class="slots-container">
                    <p id="slots-placeholder">Selecciona una fecha para ver los horarios...</p>
                </div>
                {% if form.hora.errors %}<div class="form-error">{{ form.hora.errors }}</div>{% endif %}
            </div>
            
            {{ form.hora.as_hidden }}

            <!-- EL BOTÓN AHORA EMPIEZA CON LA CLASE 'is-disabled' Y SIN EL ATRIBUTO 'disabled' -->
            <button type="submit" class="btn-submit is-disabled">Solicitar Turno</button>
        </form>
    </div>

    <!-- SECCIÓN DE RESEÑAS (sin cambios) -->
    <div class="reseñas-container">
        <!-- ... (todo tu código de reseñas se queda igual) ... -->
    </div>
</div>

<!-- ================================================================ -->
<!-- ========== ESTILOS COMPLETOS Y CORREGIDOS PARA LA PÁGINA ========== -->
<!-- ================================================================ -->
<style>
    /* Estilos del formulario y layout */
    .turno-form-container { background-color: #333; padding: 30px; border-radius: 8px; max-width: 600px; margin: 40px auto; }
    .form-group { margin-bottom: 20px; }
    .slots-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; background-color: #2a2a2a; border-radius: 5px; min-height: 50px; }
    .form-error { color: #ff6b6b; background-color: #5d1a1a; padding: 10px; border-radius: 5px; margin-top: 5px; }

    /* Estilos de los botones de slot */
    .slot-button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
    .slot-button.selected { background-color: #28a745; font-weight: bold; }

    /* Estilos del botón de envío (LA PARTE CLAVE) */
    .btn-submit {
        /* Estilo base, para cuando está HABILITADO */
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        width: 100%;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s, opacity 0.2s;
        opacity: 1;
    }
    .btn-submit.is-disabled {
        /* Estilo que SOBREESCRIBE el base cuando está DESHABILITADO */
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none; /* Crucial: Evita cualquier clic */
    }
.reseñas-container { background-color: #333; padding: 30px; border-radius: 8px; max-width: 800px; margin: 40px auto; }
.resumen-calificacion { text-align: center; margin-bottom: 30px; }
.promedio-numero { font-size: 3em; font-weight: bold; }
.promedio-estrellas { font-size: 1.5em; color: #ffc107; margin: 0 10px; }
.reseña-card { border-bottom: 1px solid #555; padding: 20px 0; }
.reseña-card:last-child { border-bottom: none; }
.reseña-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
.reseña-usuario { font-weight: bold; }
.reseña-fecha { font-size: 0.9em; color: #999; }
.reseña-calificacion { color: #ffc107; margin-bottom: 10px; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fechaInput = document.getElementById('id_fecha');
    const horaInput = document.getElementById('id_hora');
    const slotsContainer = document.getElementById('slotsContainer');
    const submitButton = document.querySelector('button.btn-submit'); // Seleccionamos por su clase

    let selectedSlotButton = null;

    async function cargarSlots(fecha) {
        slotsContainer.innerHTML = '<p>Cargando horarios...</p>';
        // Siempre deshabilitamos el botón al cargar nuevos slots
        submitButton.classList.add('is-disabled');

        try {
            const url = `/api/slots-disponibles/{{ servicio.id }}/?fecha=${fecha}`;
            const response = await fetch(url);
            const data = await response.json();
            
            slotsContainer.innerHTML = '';
            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'slot-button';
                    button.textContent = slot;
                    button.dataset.hora = slot;
                    
                    button.addEventListener('click', function() {
                        if (selectedSlotButton) {
                            selectedSlotButton.classList.remove('selected');
                        }
                        this.classList.add('selected');
                        selectedSlotButton = this;

                        horaInput.value = this.dataset.hora;
                        
                        // ¡LA CORRECCIÓN! Quitamos la clase para habilitarlo
                        submitButton.classList.remove('is-disabled');
                    });
                    
                    slotsContainer.appendChild(button);
                });
            } else {
                slotsContainer.innerHTML = '<p>No hay horarios disponibles para este día.</p>';
            }
        } catch (error) {
            console.error('Error al cargar los slots:', error);
            slotsContainer.innerHTML = '<p style="color:red;">Error al cargar horarios.</p>';
        }
    }

    // Evento para cuando el usuario cambia la fecha
    fechaInput.addEventListener('change', function() {
        // Al cambiar de fecha, siempre volvemos a deshabilitar el botón
        submitButton.classList.add('is-disabled');
        cargarSlots(this.value);
    });

    // Cargar slots para la fecha inicial al cargar la página
    if (fechaInput.value) {
        cargarSlots(fechaInput.value);
    }
    
    // Capa extra de seguridad: prevenir el envío si el botón está deshabilitado
    document.getElementById('turnoForm').addEventListener('submit', function(e) {
        if (submitButton.classList.contains('is-disabled')) {
            e.preventDefault(); // Detiene el envío del formulario
        }
    });
});
</script>
{% endblock %}