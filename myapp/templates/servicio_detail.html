{% extends 'layouts/navbar.html' %}
{% load static %}
{% block title %}{{ servicio.nombre }} en Turnos Online{% endblock %}
{% block meta_description %}Reserva tu turno en {{ servicio.nombre }}. {{ servicio.descripcion|truncatewords:20 }}{% endblock %}
{% load custom_filters %}
{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lato&family=Montserrat&family=Open+Sans&family=Playfair+Display&family=Roboto&display=swap" rel="stylesheet">
{% block styles_extra %}
<style>
    :root {
        --color-primario-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_primario }}{% else %}#007bff{% endif %};
        --color-fondo-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_fondo }}{% else %}#343a40{% endif %};
        --color-texto-servicio: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.color_texto }}{% else %}#ffffff{% endif %};
        --fuente-titulos: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.fuente_titulos }}{% else %}'Montserrat', sans-serif{% endif %};
        --fuente-cuerpo: {% if servicio.tiene_apariencia_premium_activa %}{{ servicio.fuente_cuerpo }}{% else %}'Roboto', sans-serif{% endif %};
    }
    .turno-form-container h1, .reseñas-container h2 {
        font-family: var(--fuente-titulos);
    }
    body, .turno-form-container p, .reseñas-container p, .subservicio-item {
        font-family: var(--fuente-cuerpo);
    }
    .banner-servicio {
        width: 100%; height: 300px;
        background-size: cover; background-position: center;
    }
    .turno-form-container, .reseñas-container { background-color: var(--color-fondo-servicio); color: var(--color-texto-servicio);}
    .slot-button, .btn-submit { background-color: var(--color-primario-servicio); }
    .slot-button.selected, .subservicio-item.selected { background-color: #28a745 !important; }
    .btn-submit.is-disabled { background-color: #555 !important; }
</style>
{% endblock %}

{% if servicio.imagen_banner and servicio.tiene_apariencia_premium_activa %}
    <div class="banner-servicio" style="background-image: url('{{ servicio.imagen_banner.url }}');"></div>
{% endif %}


<div class="container">
    <div class="turno-form-container" {% if servicio.imagen_banner %}style="margin-top: 20px;"{% endif %}>
        <h1>Solicitar turno para: {{ servicio.nombre }}</h1>
        <p>{{ servicio.descripcion }}</p>
        
        <form method="post" id="turnoForm">
            {% csrf_token %}
            {% if form.non_field_errors %}<div class="form-error">{{ form.non_field_errors|join:", " }}</div>{% endif %}
            
            <div class="form-group">
                <label>1. Elige los servicios que deseas:</label>
                <div id="subservicios-list">
                    {% for subservicio in servicio.sub_servicios.all %}
                        <div class="subservicio-item" data-id="{{ subservicio.id }}" data-duracion="{{ subservicio.duracion }}" data-precio="{{ subservicio.precio }}">
                            <strong>{{ subservicio.nombre }}</strong> 
                            <span>({{ subservicio.duracion }} min) - ${{ subservicio.precio|floatformat:2 }}</span>
                        </div>
                    {% empty %}
                        <p>Este negocio aún no ha cargado su catálogo de servicios.</p>
                    {% endfor %}
                </div>
                <div style="display:none;">{{ form.sub_servicios_solicitados }}</div>
            </div>

            <div id="resumen-turno" style="display: none;">
                <p><strong>Duración Total:</strong> <span id="duracion-total">0</span> minutos</p>
                <p><strong>Precio Total Estimado:</strong> $<span id="precio-total">0.00</span></p>
            </div>
            
            <div id="reserva-pasos-siguientes" style="display: none;">
                <div class="form-group">
                    <label for="id_fecha">2. Selecciona una fecha:</label>
                    {{ form.fecha }}
                </div>
                <div class="form-group">
                    <label>3. Elige un horario disponible:</label>
                    <div id="slotsContainer" class="slots-container"></div>
                </div>
            </div>
            
            {{ form.hora.as_hidden }}
            <button type="submit" class="btn-submit is-disabled">Solicitar Turno</button>
        </form>
    </div>

    <div class="reseñas-container" id="seccion-reseñas">
    <h2>Opiniones de Nuestros Clientes</h2>
    
    {% if calificacion_promedio %}
        <div class="resumen-calificacion">
            <span class="promedio-numero">{{ calificacion_promedio|floatformat:1 }}</span>
            <span class="promedio-estrellas">
            </span>
            <span class="total-reseñas">(basado en {{ conteo_total_reseñas }} reseñas)</span>
        </div>

        <div class="filtros-reseñas">
            <a href="{% url 'servicio_detail' servicio.slug %}" class="filtro-btn {% if not filtro_activo %}active{% endif %}">Todas ({{ conteo_total_reseñas }})</a>
            {% for i in "54321"|make_list %}
                {% with star_count=conteo_estrellas|get_item:i|default:0 %}
                <a href="?calificacion={{ i }}" class="filtro-btn {% if filtro_activo == i|add:0 %}active{% endif %}">
                    {{ i }} <i class="fas fa-star"></i> ({{ star_count }})
                </a>
                {% endwith %}
            {% endfor %}
        </div>

        <div id="lista-reseñas" class="lista-reseñas">
            {% for reseña in reseñas %}
                <div class="reseña-card">
                    <div class="reseña-header">
                        <span class="reseña-usuario">{{ reseña.usuario.username }}</span>
                        <span class="reseña-fecha">{{ reseña.fecha_creacion|date:"d/m/Y" }}</span>
                    </div>
                    <div class="reseña-calificacion">
                        {% for i in "12345"|make_list %}{% if reseña.calificacion >= i|add:0 %}<i class="fas fa-star"></i>{% endif %}{% endfor %}
                    </div>
                    <p class="reseña-comentario">{{ reseña.comentario|linebreaksbr }}</p>
                </div>
            {% empty %}
                <p>No hay reseñas que coincidan con este filtro.</p>
            {% endfor %}
        </div>
        
        {% if tiene_mas_paginas %}
        <div class="load-more-container">
            <button id="load-more-reviews" class="btn-load-more">Cargar más reseñas</button>
        </div>
        {% endif %}

    {% else %}
        <p>Este servicio aún no tiene reseñas. ¡Sé el primero en dejar una!</p>
    {% endif %}
</div>

<footer class="footer-estructurado">
    <div class="container footer-grid">
        
        <div class="footer-columna footer-mapa">
            <h4>Ubicación</h4>
            {% if servicio.footer_direccion and google_maps_api_key %}
                <div class="map-container">
                    <iframe
                        width="100%"
                        height="200"
                        style="border:0; border-radius: 8px;"
                        loading="lazy"
                        allowfullscreen
                        src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q={{ servicio.footer_direccion|urlencode }}">
                    </iframe>
                </div>
            {% else %}
                <p>La dirección no ha sido especificada por el propietario.</p>
            {% endif %}
        </div>

        <div class="footer-columna">
            <h4>Contacto</h4>
            {% if servicio.footer_direccion %}<p><i class="fas fa-map-marker-alt"></i> {{ servicio.footer_direccion }}</p>{% endif %}
            {% if servicio.footer_telefono %}<p><i class="fas fa-phone"></i> {{ servicio.footer_telefono }}</p>{% endif %}
            {% if servicio.footer_email %}<p><i class="fas fa-envelope"></i> {{ servicio.footer_email }}</p>{% endif %}
        </div>

        <div class="footer-columna">
            <h4>Síguenos en Redes</h4>
            <div class="social-links">
                {% if servicio.footer_facebook_url %}<a href="{{ servicio.footer_facebook_url }}" target="_blank"><i class="fab fa-facebook-f"></i></a>{% endif %}
                {% if servicio.footer_instagram_url %}<a href="{{ servicio.footer_instagram_url }}" target="_blank"><i class="fab fa-instagram"></i></a>{% endif %}
                {% if servicio.footer_tiktok_url %}<a href="{{ servicio.footer_tiktok_url }}" target="_blank"><i class="fab fa-tiktok"></i></a>{% endif %}
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>© {% now "Y" %} {{ servicio.nombre }}. Todos los derechos reservados.</p>
    </div>
</footer>

<style>
    .turno-form-container, .reseñas-container {
        padding: 30px;
        border-radius: 8px;
        max-width: 600px;
        margin: 40px auto;
    }
    .reseñas-container {
        max-width: 800px;
    }
    .form-group { margin-bottom: 20px; }
    .slots-container { display: flex;justify-content: center ; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; background-color: #2a2a2a; border-radius: 5px; min-height: 50px; }
    .slot-button { color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
    .form-error { color: #ff6b6b; background-color: #5d1a1a; padding: 10px; border-radius: 5px; margin-top: 5px; }
    .btn-submit { color: white; padding: 10px 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; opacity: 1; }
    .btn-submit.is-disabled { cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .resumen-calificacion { text-align: center; margin-bottom: 30px; }
    .promedio-numero { font-size: 3em; font-weight: bold; }
    .promedio-estrellas { font-size: 1.5em; color: #ffc107; margin: 0 10px; }
    .reseña-card { border-bottom: 1px solid #555; padding: 20px 0; }
    .reseña-card:last-child { border-bottom: none; }
    .reseña-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .reseña-usuario { font-weight: bold; }
    .reseña-fecha { font-size: 0.9em; color: #999; }
    .reseña-calificacion { color: #ffc107; margin-bottom: 10px; }

    .footer-estructurado { background-color: var(--color-fondo-servicio, #222); color: var(--color-texto-servicio, #ccc); padding: 40px 0 20px 0; margin-top: 50px; border-top: 3px solid var(--color-primario-servicio, #007bff); }
    .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; }
    .footer-columna h4 { font-family: var(--fuente-titulos);  color: var(--color-texto-servicio);  margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
    .footer-columna p { font-family: var(--fuente-cuerpo); line-height: 1.6; }
    .footer-columna i { color: var(--color-primario-servicio); margin-right: 10px; }
    .social-links a { color: #ccc; font-size: 1.8em; margin-right: 15px; transition: color 0.2s; }
    .social-links a:hover { color: var(--color-primario-servicio); }
    .footer-bottom { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #444; font-size: 0.9em; }
    .filtros-reseñas { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; justify-content: center; }
    .filtro-btn { background-color: #444; color: #ccc; padding: 8px 15px; border-radius: 20px; text-decoration: none; transition: all 0.2s; }
    .filtro-btn.active, .filtro-btn:hover { background-color: var(--color-primario-servicio); color: white; }
    .load-more-container { text-align: center; margin-top: 30px; }
    .btn-load-more { background-color: transparent; border: 1px solid var(--color-primario-servicio); color: var(--color-primario-servicio); padding: 10px 25px; border-radius: 5px; cursor: pointer; }
    .footer-mapa .map-container {
        width: 100%;
        height: 200px; 
    }
    .subservicio-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background-color: #444; padding: 12px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; border-left: 4px solid transparent; }
    .subservicio-item:hover { background-color: #555; }
    .subservicio-item.selected { font-weight: bold; border-left-color: var(--color-primario-servicio); }
    #resumen-turno { background: #2a2a2a; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid aqua; }
    .subservicio-item input[type="checkbox"] { display: none; } 
    .subservicio-item label { cursor: pointer; width: 100%; } 
    #resumen-turno { background: #2a2a2a; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid aqua; }
</style>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const subserviciosItems = document.querySelectorAll('.subservicio-item');
    const duracionTotalDisplay = document.getElementById('duracion-total');
    const precioTotalDisplay = document.getElementById('precio-total');
    const resumenDiv = document.getElementById('resumen-turno');
    const reservaPasosDiv = document.getElementById('reserva-pasos-siguientes');
    const fechaInput = document.getElementById('id_fecha');
    const horaInput = document.getElementById('id_hora');
    const slotsContainer = document.getElementById('slotsContainer');
    const submitButton = document.querySelector('button.btn-submit');
    const formCheckboxes = document.querySelectorAll('input[name="sub_servicios_solicitados"]');

    let duracionTotalCalculada = 0;
    let selectedSlotButton = null;

    function actualizarResumenYPasos() {
        let duracionTotal = 0;
        let precioTotal = 0.0;
        let seleccionados = [];
        
        subserviciosItems.forEach(item => {
            if (item.classList.contains('selected')) {
                duracionTotal += parseInt(item.dataset.duracion, 10);
                precioTotal += parseFloat(item.dataset.precio);
                seleccionados.push(item.dataset.id);
            }
        });

        formCheckboxes.forEach(cb => {
            cb.checked = seleccionados.includes(cb.value);
        });

        duracionTotalCalculada = duracionTotal;
        duracionTotalDisplay.textContent = duracionTotal;
        precioTotalDisplay.textContent = precioTotal.toFixed(2);

        if (duracionTotal > 0) {
            resumenDiv.style.display = 'block';
            reservaPasosDiv.style.display = 'block';
            if (fechaInput.value) {
                cargarSlots(fechaInput.value, duracionTotalCalculada);
            }
        } else {
            resumenDiv.style.display = 'none';
            reservaPasosDiv.style.display = 'none';
            submitButton.classList.add('is-disabled');
        }
    }

    async function cargarSlots(fecha, duracion) {
       slotsContainer.innerHTML = '<p>Buscando horarios...</p>';
        submitButton.classList.add('is-disabled');
        selectedSlotButton = null;
        horaInput.value = '';

        try {
            const url = `/api/slots-disponibles/{{ servicio.id }}/?fecha=${fecha}&duracion=${duracion}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Respuesta del servidor no fue OK');
            const data = await response.json();
            
            slotsContainer.innerHTML = '';
            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'slot-button';
                    button.textContent = slot;
                    button.dataset.hora = slot;
                    
                    button.addEventListener('click', function() {
                        if (selectedSlotButton) { selectedSlotButton.classList.remove('selected'); }
                        this.classList.add('selected');
                        selectedSlotButton = this;
                        horaInput.value = this.dataset.hora;
                        submitButton.classList.remove('is-disabled');
                    });
                    slotsContainer.appendChild(button);
                });
            } else {
                slotsContainer.innerHTML = '<p>No hay horarios disponibles para esta combinación.</p>';
            }
        } catch (error) {
            console.error("Error al cargar slots:", error);
            slotsContainer.innerHTML = '<p style="color:red;">Error al cargar horarios. Intenta de nuevo.</p>';
        }
    }

    subserviciosItems.forEach(item => {
        item.addEventListener('click', function() {
            this.classList.toggle('selected');
            actualizarResumenYPasos();
        });
    });

    fechaInput.addEventListener('change', function() {
        submitButton.classList.add('is-disabled');
        if (this.value && duracionTotalCalculada > 0) {
            cargarSlots(this.value, duracionTotalCalculada);
        }
    });
    actualizarResumenYPasos();
});
</script>
 <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadMoreButton = document.getElementById('load-more-reviews');
        const reviewsContainer = document.getElementById('lista-reseñas');
        
        if (!loadMoreButton) return;

        let currentPage = 2; 
        const urlParams = new URLSearchParams(window.location.search);
        const calificacionFiltro = urlParams.get('calificacion') || '';

        function generateStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<i class="fas fa-star"></i>';
                }
            }
            return starsHtml;
        }

        async function loadMoreReviews() {
            loadMoreButton.textContent = 'Cargando...';
            loadMoreButton.disabled = true;

            const apiUrl = `/api/reseñas/{{ servicio.slug }}/?page=${currentPage}&calificacion=${calificacionFiltro}`;
            
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                data.reseñas.forEach(reseña => {
                    const reviewCardHTML = `
                        <div class="reseña-card">
                            <div class="reseña-header">
                                <span class="reseña-usuario">${reseña.usuario}</span>
                                <span class="reseña-fecha">${reseña.fecha_creacion}</span>
                            </div>
                            <div class="reseña-calificacion">${generateStars(reseña.calificacion)}</div>
                            <p class="reseña-comentario">${reseña.comentario.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                    reviewsContainer.insertAdjacentHTML('beforeend', reviewCardHTML);
                });

                if (data.has_next_page) {
                    currentPage++;
                    loadMoreButton.textContent = 'Cargar más reseñas';
                    loadMoreButton.disabled = false;
                } else {
                    loadMoreButton.style.display = 'none'; 
                }
            } catch (error) {
                console.error('Error al cargar más reseñas:', error);
                loadMoreButton.textContent = 'Error al cargar. Reintentar.';
                loadMoreButton.disabled = false;
            }
        }

        loadMoreButton.addEventListener('click', loadMoreReviews);
    });
    </script>
{% endblock %}